<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Warriors! Complete Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        :root {
            --sat: env(safe-area-inset-top, 0px);
            --sar: env(safe-area-inset-right, 0px);
            --sab: env(safe-area-inset-bottom, 0px);
            --sal: env(safe-area-inset-left, 0px);
        }

        body {
            margin: 0; padding: 0; background-color: #050505;
            overflow: hidden; touch-action: none;
            font-family: 'Press Start 2P', 'DotGothic16', 'Microsoft JhengHei', sans-serif;
            user-select: none; width: 100%; height: 100vh;
        }

        #game-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { image-rendering: pixelated; width: 100%; height: 100%; display: block; }

        /* UI LAYERS */
        .ui-layer { position: absolute; bottom: max(10px, var(--sab)); display: flex; gap: 2vmin; pointer-events: none; z-index: 20; height: 18vh; align-items: center; }
        #p1-ui { left: max(20px, var(--sal)); display: none; }
        #p2-ui { right: max(20px, var(--sar)); display: none; }

        .unit-btn {
            pointer-events: auto; width: 15vh; height: 15vh; max-width: 90px; max-height: 90px;
            border: 0.4vh solid #444; background: #222; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5vh; cursor: pointer; box-shadow: 0.5vh 0.5vh 0px #000; transition: transform 0.1s;
        }
        .unit-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #000; }
        .unit-btn.selected-p1 { border-color: #4444ff; background: #333366; transform: translateY(-0.5vh); }
        .unit-btn.selected-p2 { border-color: #ff4444; background: #663333; transform: translateY(-0.5vh); }
        .icon { font-size: 4vh; margin-bottom: 0.5vh; }

        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 10;
        }
        
        /* MENUS */
        #main-menu, #campaign-menu, #slot-lobby-menu, #map-select-menu, #instructions-screen, #upgrade-menu, #skill-tree-menu, #treasury-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; padding-left: var(--sal); padding-right: var(--sar);
        }
        #main-menu { background: rgba(0, 0, 0, 0.3); }
        #campaign-menu, #slot-lobby-menu, #map-select-menu, #instructions-screen, #upgrade-menu, #skill-tree-menu { 
            display: none; background: rgba(10, 10, 20, 0.95); backdrop-filter: blur(5px);
        }
        #upgrade-menu { z-index: 100; }

        @keyframes logoShake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-2px, 2px) rotate(-1deg); }
            50% { transform: translate(2px, -2px) rotate(1deg); }
            75% { transform: translate(-2px, -2px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .menu-logo {
            font-size: 6vh; line-height: 1.2; text-align: center; color: #ffcc00; margin-bottom: 3vh;
            animation: logoShake 0.5s linear infinite; -webkit-text-stroke: 0.3vh #8b0000;
            text-shadow: 3px 3px 0 #ff0000, 6px 6px 0 #8b0000; font-weight: bold; letter-spacing: 0.5vh;
        }
        
        .section-title { font-size: 3vh; color: #fff; margin-bottom: 3vh; text-shadow: 2px 2px 0 #000; text-align: center; }
        .mode-container { display: flex; gap: 4vw; flex-wrap: wrap; justify-content: center; align-items: center; width: 100%; }

        /* CARDS & SLOTS */
        .mode-card, .map-card, .card-choice {
            background: #222; border: 0.5vh solid #fff; box-shadow: 1vh 1vh 0px #000;
            display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s;
            overflow: hidden; width: 28vh; height: 38vh; min-width: 160px; min-height: 220px; position: relative;
        }
        .mode-card:hover, .map-card:hover { transform: translateY(-1vh) scale(1.05); border-color: #ffcc00; box-shadow: 0 0 30px rgba(255, 100, 0, 0.6); }
        .card-visual { flex: 2; width: 100%; position: relative; border-bottom: 0.5vh solid #fff; overflow: hidden; }
        .card-visual::after { font-size: 8vh !important; }
        .card-visual::before { font-size: 6vh !important; }
        
        /* Save Slot Styling */
        .save-slot-container { display: flex; flex-direction: column; gap: 2vh; width: 100%; align-items: center; max-height: 50vh; overflow-y: auto; width: 80%; max-width: 600px;}
        .save-slot {
            background: #333; border: 0.4vh solid #555; width: 100%;
            padding: 1.5vh 2vh; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.1s; position: relative; box-shadow: 0.5vh 0.5vh 0 #000;
            box-sizing: border-box;
        }
        .save-slot:hover { border-color: #ffd700; background: #444; transform: scale(1.02); }
        .save-slot.empty { border-style: dashed; opacity: 0.8; }
        .save-slot-info { display: flex; flex-direction: column; text-align: left; }
        .slot-title { font-size: 1.8vh; color: #fff; margin-bottom: 0.5vh; }
        .slot-details { font-size: 1.2vh; color: #aaa; }
        .slot-delete-btn {
            background: #822; color: #fff; border: 0.2vh solid #f55;
            padding: 1vh 1.5vh; font-size: 1.5vh; cursor: pointer; z-index: 10; margin-left: 2vh;
            display: flex; align-items: center; justify-content: center;
        }
        .slot-delete-btn:hover { background: #d33; transform: scale(1.1); }
        .slot-icon { font-size: 2.5vh; margin-right: 1.5vh; }

        /* VISUALS */
        @keyframes skyScroll { 0% { background-position: 0 0; } 100% { background-position: 100% 0; } }
        @keyframes charWalk { 0%, 100% { transform: scaleX(-1) translateY(0); } 50% { transform: scaleX(-1) translateY(-0.5vh); } }
        @keyframes burstRotate { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        
        .visual-single { background: linear-gradient(to bottom, #87CEEB, #4CAF50); background-size: 200% 100%; }
        .visual-single::before { content: ""; position: absolute; top: 0; left: 0; width: 200%; height: 50%; background-image: radial-gradient(circle, #fff 20%, transparent 20%); background-size: 4vh 4vh; opacity: 0.6; animation: skyScroll 10s linear infinite; }
        .visual-single-hero { position: absolute; left: 20%; bottom: 10%; font-size: 8vh; filter: drop-shadow(0.5vh 0.5vh 0 #000); animation: charWalk 0.8s infinite steps(2); z-index: 2; }
        .visual-multi { background: #222; overflow: hidden; }
        .visual-multi::before { content: ""; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; background: repeating-conic-gradient(#4444ff 0 15deg, #ff4444 15deg 30deg); opacity: 0.3; animation: burstRotate 10s linear infinite; }
        .visual-multi-swords { position: absolute; top: 50%; left: 50%; font-size: 10vh; filter: drop-shadow(0.5vh 0.5vh 0 #000); transform: translate(-50%, -50%); z-index: 2; }

        /* Map Visuals */
        .visual-grass { background: #2d402d; } .visual-grass::after { content: "üå≤"; font-size: 8vh; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); }
        .visual-lava { background: #330000; } .visual-lava::after { content: "üåã"; font-size: 8vh; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); }
        .visual-snow { background: #ccddff; } .visual-snow::after { content: "‚ùÑÔ∏è"; font-size: 8vh; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); }

        .btn-generic { 
            margin-top: 1.5vh; padding: 1.5vh 4vh; background: #444; color: #fff; border: 0.4vh solid #fff; 
            font-family: 'Press Start 2P', 'DotGothic16', monospace; cursor: pointer; font-size: 2vh;
            transition: 0.2s; text-align: center; width: 200px;
        }
        .btn-generic:hover { background: #666; border-color: #ffd700; transform: scale(1.1); }
        .card-info { flex: 1; padding: 1.5vh; text-align: center; background: #333; color: #fff; display: flex; flex-direction: column; justify-content: center; z-index: 2;}
        .card-title { font-size: 2vh; color: #ffd700; margin-bottom: 1vh; font-weight: bold; letter-spacing: 1px;}
        .card-desc { font-size: 1.4vh; color: #ccc; }
        .card-choice .card-icon { font-size: 6vh; margin: 2vh 0; text-align: center; text-shadow: 4px 4px #000; }
        .credits { margin-top: 3vh; font-size: 1.2vh; color: #888; }

        /* Skill Tree */
        #skill-tree-container { position: relative; width: 90vw; height: 70vh; max-width: 600px; background: #222; border: 0.5vh solid #444; overflow: hidden; }
        #stars-display { font-size: 3vh; color: #ffd700; margin-bottom: 2vh; text-shadow: 0 0 10px #ff0; }
        .skill-node { position: absolute; width: 7vh; height: 7vh; background: #333; border: 0.3vh solid #666; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; z-index: 5; transform: translate(-50%, -50%); transition: all 0.2s; box-shadow: 0.3vh 0.3vh 0 #000; border-radius: 1vh; }
        .skill-node:active { transform: translate(-50%, -50%) scale(0.95); }
        .skill-node.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .skill-node.unlocked { border-color: #0f0; background: #224422; box-shadow: 0 0 10px #0f0; }
        .skill-node.available { border-color: #ffd700; background: #444; animation: pulse 2s infinite; }
        .skill-icon { font-size: 2.5vh; } .skill-cost { font-size: 1vh; color: #ffd700; }
        .skill-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .skill-path { stroke: #444; stroke-width: 3; fill: none; } .skill-path.active { stroke: #0f0; stroke-width: 4; }
        .skill-tooltip { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); border-top: 0.2vh solid #fff; padding: 2vh; font-size: 1.5vh; color: #fff; text-align: center; display: none; z-index: 20; box-sizing: border-box; }
        .skill-node:hover .skill-tooltip { display: block; }
        .btn-skill-tree { background: #202040; border-color: #66f; }
        
        /* INSTRUCTIONS & TABS */
        .instruction-box { background: rgba(20,20,20,0.95); border: 0.5vh solid #fff; padding: 2vh; width: 80vw; max-width: 800px; color: #fff; max-height: 75vh; overflow-y: auto; text-align: left; display: flex; flex-direction: column; }
        .inst-tabs { display: flex; width: 100%; border-bottom: 2px solid #555; margin-bottom: 2vh; }
        .inst-tab { flex: 1; text-align: center; padding: 1.5vh; background: #222; cursor: pointer; color: #888; font-size: 1.8vmin; transition: 0.2s; border-top: 2px solid transparent; }
        .inst-tab:hover { background: #333; color: #ccc; }
        .inst-tab.active { background: #444; color: #ffd700; border-top-color: #ffd700; border-bottom: 2px solid #444; margin-bottom: -2px; }
        .inst-content { display: none; animation: fadeIn 0.3s; }
        .inst-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .inst-row { display: flex; align-items: center; margin-bottom: 2vh; }
        .inst-icon { font-size: 4vmin; margin-right: 3vmin; width: 5vmin; text-align: center; }
        .inst-text { font-size: 2vmin; line-height: 1.6; color: #ccc; }
        
        /* TYPE CHART */
        .type-chart { display: flex; flex-direction: column; gap: 1.5vh; background: #000; padding: 2vh; border: 2px solid #444; margin-top: 2vh; }
        .type-row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px dashed #333; padding-bottom: 1vh; }
        .type-row:last-child { border-bottom: none; }
        .type-name { width: 30%; font-weight: bold; font-size: 2vmin; }
        .type-adv { width: 65%; font-size: 1.8vmin; color: #aaa; line-height: 1.4; }
        .strong { color: #0f0; font-weight: bold; } .weak { color: #f44; font-weight: bold; }
        
        #top-hud { position: absolute; top: max(15px, var(--sat)); left: 50%; transform: translateX(-50%); color: #fff; text-align: center; z-index: 10; pointer-events: none; text-shadow: 2px 2px #000; display: none; }
        #game-time { font-size: 2.5vh; margin-bottom: 0.5vh; }
        #council-timer { font-size: 1.5vh; color: #ffd700; }
        #diff-label { color: #f00; font-size: 1.2vh; margin-top: 0.5vh; }
        
        #game-over-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; background: rgba(0, 0, 0, 0.95); flex-direction: column; justify-content: center; align-items: center; color: white; }
       

       
        #stats-container { margin-top: 2vh; background: #222; border: 0.5vh solid #fff; padding: 2vh; width: 80%; max-width: 600px; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 1vh; font-size: 1.8vh; border-bottom: 1px dashed #444; padding-bottom: 0.5vh; }
        
        #lang-switch { position: absolute; top: max(15px, var(--sat)); right: max(140px, var(--sar)); display: flex; gap: 1vh; z-index: 100; }
        .lang-btn { background: #222; color: #888; border: 2px solid #555; padding: 1vh; cursor: pointer; font-size: 1.2vh; }
        .lang-btn.active { color: #fff; border-color: #ffd700; background: #444; }
        #mute-btn { position: absolute; top: max(15px, var(--sat)); right: max(20px, var(--sar)); background: #333; color: #fff; border: 2px solid #fff; padding: 1vh 1.5vh; cursor: pointer; z-index: 100; font-size: 1.2vh; }

        @keyframes pulse { 0% { box-shadow: 0 0 5px #ffd700; } 50% { box-shadow: 0 0 15px #ffd700; } 100% { box-shadow: 0 0 5px #ffd700; } }
		/* --- TAP TO START SCREEN --- */
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 999; /* ÊúÄ‰∏äÂ±§ */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .blink-text { animation: blink 1s infinite; color: #fff; font-size: 2.5vh; margin-top: 5vh; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        
        /* Custom Modal */
        #custom-modal {
            display:none; position:absolute; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.8); z-index:2000;
            flex-direction:column; justify-content:center; align-items:center;
            backdrop-filter: blur(2px);
        }
 
        .modal-box {
            background:#222; border:2px solid #fff; padding:3vh;
            text-align:center; color:#fff; font-family:'Press Start 2P';
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            width: 80%; max-width: 400px;
        }

        /* DICE GAME UI */
        #dice-modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:500; flex-direction:column; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .dice-box { background:#222; border:0.5vh solid #ffd700; padding:4vh; text-align:center; border-radius: 2vh; box-shadow: 0 0 30px #ffd700; width: 80vw; max-width: 400px; }
        .dice-display { font-size: 10vh; margin: 3vh 0; animation: bounce 0.5s infinite; color: #fff; text-shadow: 0 0 10px #fff; }
        .treasure-reveal { display: none; flex-direction: column; align-items: center; animation: fadeIn 0.5s; }
        .treasure-icon { font-size: 8vh; margin: 2vh; filter: drop-shadow(0 0 10px #fff); }
        .treasure-name { font-size: 2.5vh; color: #ffd700; margin-bottom: 1vh; }
        .treasure-desc { font-size: 1.5vh; color: #aaa; margin-bottom: 3vh; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* TREASURY MENU */
        #treasury-menu { display:none; background:rgba(10,10,15,0.98); z-index:60; }
        .treasure-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5vh; 
            margin-bottom: 2vh; width: 90vw; max-width: 500px;
        }
        .t-item {
            aspect-ratio: 1/1; background: #222; border: 0.3vh solid #444; border-radius: 1vh;
            display: flex; justify-content: center; align-items: center; font-size: 3vh;
            cursor: pointer; transition: all 0.1s; position: relative;
        }
        .t-item:active { transform: scale(0.95); }
        .t-item.locked { color: #555; font-size: 2vh; border-style: dashed; }
        .t-item.unlocked { border-color: #ffd700; background: #332200; box-shadow: 0 0 5px #ffd700; }
        .t-item.selected { background: #664400; border-color: #fff; transform: scale(1.1); z-index: 2; }
        
        #t-detail-box { 
            width: 80vw; max-width: 500px; background: #111; border: 0.4vh solid #666; 
            padding: 2vh; min-height: 15vh; display: flex; flex-direction: column; align-items: center;
            text-align: center; margin-bottom: 2vh;
        }
        #t-detail-icon { font-size: 6vh; margin-bottom: 1vh; filter: drop-shadow(0 0 10px #fff); }
        #t-detail-name { font-size: 2vh; color: #ffd700; margin-bottom: 1vh; }
        #t-detail-desc { font-size: 1.4vh; color: #aaa; line-height: 1.5; }
    </style>
</head>

<body>

<div id="game-container">
    <div id="splash-screen" onclick="startApp()">
        <div class="menu-logo txt-title" style="font-size: 8vh;">WARRIORS!<br>GO! GO! GO!</div>
        <div class="blink-text">TAP TO START</div>
        <div style="font-size: 1.5vh; color: #666; margin-top: 10vh;">SOUND ON RECOMMENDED</div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div class="scanlines"></div>
    <div id="mute-btn" onclick="toggleMute()">SOUND: ON</div>
    
    <div id="lang-switch">
        <div class="lang-btn active" onclick="setLanguage('zh-TW')">ÁπÅ</div>
        <div class="lang-btn" onclick="setLanguage('en')">EN</div>
        <div class="lang-btn" onclick="setLanguage('ja')">Êó•</div>
    </div>
    
    <div id="top-hud">
        <div id="game-time">00:00</div>
        <div id="council-timer">NEXT COUNCIL: 30s</div>
        <div id="diff-label">STAGE 1</div>
    </div>

    <!-- P1 UI -->
    <div id="p1-ui" class="ui-layer">
        <div class="unit-btn selected-p1" id="btn-p1-sword" onclick="selectUnit(1, 'SWORD')"><span class="icon" style="color:#ff5555">‚öîÔ∏è</span><div class="txt-sword">ÂäçÂÖµ</div><div style="color:#aaa; font-size:1vh;">$20</div></div>
        <div class="unit-btn" id="btn-p1-spear" onclick="selectUnit(1, 'SPEAR')"><span class="icon" style="color:#5555ff">üî±</span><div class="txt-spear">ÊßçÂÖµ</div><div style="color:#aaa; font-size:1vh;">$20</div></div>
        <div class="unit-btn" id="btn-p1-axe" onclick="selectUnit(1, 'AXE')"><span class="icon" style="color:#55ff55">ü™ì</span><div class="txt-axe">ÊñßÂÖµ</div><div style="color:#aaa; font-size:1vh;">$20</div></div>
    </div>

    <!-- P2 UI -->
    <div id="p2-ui" class="ui-layer">
        <div class="unit-btn selected-p2" id="btn-p2-sword" onclick="selectUnit(2, 'SWORD')"><span class="icon" style="color:#ff5555">‚öîÔ∏è</span></div>
        <div class="unit-btn" id="btn-p2-spear" onclick="selectUnit(2, 'SPEAR')"><span class="icon" style="color:#5555ff">üî±</span></div>
        <div class="unit-btn" id="btn-p2-axe" onclick="selectUnit(2, 'AXE')"><span class="icon" style="color:#55ff55">ü™ì</span></div>
    </div>
    
    <!-- UPGRADE MENU -->
    <div id="upgrade-menu">
        <div class="section-title txt-council-title" style="color:#ffd700" id="upgrade-title">WAR COUNCIL</div>
        <div class="menu-subtitle" id="upgrade-subtitle" style="color:#fff;">CHOOSE UPGRADE</div>
        <div id="upgrade-container" class="mode-container"></div>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu">
        <div class="menu-logo txt-title">WARRIORS!<br>GO! GO! GO!</div>
        <div class="mode-container">
            <div class="mode-card" onclick="showCampaignMenu()">
                <div class="card-visual visual-single"><div class="visual-single-hero">ü¶∏‚Äç‚ôÇÔ∏è</div><div class="visual-single-castle">üè∞</div></div>
                <div class="card-info"><div class="card-title txt-solo-title">SOLO SAGA</div><div class="card-desc txt-solo-desc">Roguelike Mode.</div></div>
            </div>
            <div class="mode-card" onclick="initMultiplayer()">
                <div class="card-visual visual-multi"><div class="visual-multi-swords">‚öîÔ∏è</div></div>
                <div class="card-info"><div class="card-title txt-multi-title">VS DUEL</div><div class="card-desc txt-multi-desc">PvP Battle!</div></div>
            </div>
        </div>
        <div class="btn-generic txt-instruct-btn" onclick="showInstructions()">INSTRUCTIONS</div>
        <div class="credits txt-credits">¬© 2025 PIXEL STUDIO</div>
    </div>

    <!-- CAMPAIGN MENU (SLOTS) -->
    <div id="campaign-menu">
        <div class="section-title txt-solo-title" style="margin-bottom: 2vh;">SOLO SAGA</div>
        <!-- Slots Container -->
        <div id="save-slot-container" class="save-slot-container"></div>
        <div style="display:flex; gap:2vh; margin-top:2vh;">
            <div class="btn-generic txt-back" onclick="showMainMenu()">BACK</div>
        </div>
    </div>

    <!-- SLOT LOBBY MENU (NEW) -->
    <div id="slot-lobby-menu">
        <div class="section-title txt-lobby-title" style="margin-bottom: 2vh;">PREPARE FOR BATTLE</div>
        <div class="mode-container" style="flex-direction: column; gap: 2vh;">
             <div id="lobby-info" style="color: #fff; margin-bottom: 2vh; text-align: center; font-size: 2vh;"></div>
             <div class="btn-generic txt-start-battle" onclick="launchLevel()">START BATTLE</div>
             <div class="btn-generic btn-skill-tree" onclick="showSkillTree()">SKILL TREE</div>
             
             <div class="btn-generic txt-btn-treasury" onclick="showTreasury()">TREASURY</div>
             <div class="btn-generic txt-back" onclick="showCampaignMenu()">BACK</div>
        </div>
    </div>

    <!-- SKILL TREE MENU -->
    <div id="skill-tree-menu">
        <div class="section-title txt-skill-title">SKILL TREE</div>
        <div id="stars-display">‚≠ê: 0</div>
        <div id="skill-tree-container">
            <svg class="skill-svg" id="skill-svg"></svg>
            <!-- Nodes Populated by JS -->
        </div>
        <div style="margin-top: 2vh;" class="btn-generic txt-back" onclick="showSlotLobby()">BACK</div>
    </div>

    <!-- treasury-menu -->
    <div id="treasury-menu">
        <div class="section-title txt-t-title" style="color:#ffd700">WAR TROPHIES</div>
        <div id="t-detail-box">
            <div id="t-detail-icon">‚ùì</div>
            <div id="t-detail-name" class="txt-t-select">SELECT A TREASURE</div>
            <div id="t-detail-desc" class="txt-t-desc-default" style="color:#666">Collect trophies from victories to fill this shelf.</div>
        </div>
        <div class="treasure-grid" id="treasure-grid">
            </div>
        <div style="display:flex; gap:2vh;">
            <div class="btn-generic txt-back" onclick="showSlotLobby()">BACK</div>
        </div>
    </div>

    <!-- MAP SELECT MENU -->
    <div id="map-select-menu">
        <div class="section-title txt-map-title">SELECT BATTLEFIELD</div>
        <div class="mode-container">
            <div class="map-card" onclick="initGame('GRASS')"><div class="card-visual visual-grass"></div><div class="card-info"><div class="card-title txt-map-grass">GREEN FIELDS</div></div></div>
            <div class="map-card" onclick="initGame('LAVA')"><div class="card-visual visual-lava"></div><div class="card-info"><div class="card-title txt-map-lava">MOLTEN CORE</div></div></div>
            <div class="map-card" onclick="initGame('SNOW')"><div class="card-visual visual-snow"></div><div class="card-info"><div class="card-title txt-map-snow">FROZEN PEAKS</div></div></div>
        </div>
        <div class="btn-generic txt-back" onclick="showMainMenu()">BACK</div>
    </div>

    <!-- GAME OVER -->
    <div id="game-over-screen" onclick="handleGameOverClick()">
        <h1 id="winner-text" style="font-size: 6vh; margin-bottom: 20px;">VICTORY</h1>
        <div id="stats-container"></div>
        <p id="game-over-subtext" style="font-size: 2vh; animation: blink 1s infinite; margin-top: 20px;" class="txt-exit-tap">TAP TO RETURN TO MENU</p>
    </div>
        
    <!-- INSTRUCTIONS SCREEN (UPDATED) -->
    <div id="instructions-screen">
        <div class="section-title txt-inst-title">BATTLE GUIDE</div>
        
        <div class="instruction-box">
            <!-- TABS -->
            <div class="inst-tabs">
                <div class="inst-tab active" id="tab-basic" onclick="switchInstTab('BASIC')">BASIC</div>
                <div class="inst-tab" id="tab-solo" onclick="switchInstTab('SOLO')">SOLO</div>
                <div class="inst-tab" id="tab-multi" onclick="switchInstTab('MULTI')">VS</div>
            </div>

            <!-- TAB: BASIC -->
            <div id="inst-content-basic" class="inst-content active">
                <div class="inst-row"><div class="inst-icon">üö©</div><div class="inst-text txt-basic-goal">Goal: Destroy enemy base.</div></div>
                <div class="inst-row"><div class="inst-icon">üëÜ</div><div class="inst-text txt-basic-ctrl">Tap lanes to spawn units.</div></div>
                <div class="inst-row"><div class="inst-icon">‚ö°</div><div class="inst-text txt-basic-energy">Units cost Energy. Energy regens over time.</div></div>
                <hr style="border: 1px solid #444; margin: 1vh 0;">
                <div style="color:#ffd700; margin-bottom:1vh; text-align:center;" class="txt-type-title">WEAPON TRIANGLE</div>
                <div class="type-chart">
                    <div class="type-row"><div class="type-name txt-sword" style="color:#ff5555">‚öîÔ∏è SWORD</div><div class="type-adv"><span class="strong txt-strong-vs">Strong vs</span> <span class="txt-axe">AXE</span></div></div>
                    <div class="type-row"><div class="type-name txt-axe" style="color:#55ff55">ü™ì AXE</div><div class="type-adv"><span class="strong txt-strong-vs">Strong vs</span> <span class="txt-spear">SPEAR</span></div></div>
                    <div class="type-row"><div class="type-name txt-spear" style="color:#5555ff">üî± SPEAR</div><div class="type-adv"><span class="strong txt-strong-vs">Strong vs</span> <span class="txt-sword">SWORD</span></div></div>
                </div>
            </div>

            <!-- TAB: SOLO -->
            <div id="inst-content-solo" class="inst-content">
                <div class="inst-row"><div class="inst-icon">üè∞</div><div class="inst-text txt-solo-camp">Campaign: Clear 10 stages to win.</div></div>
                <div class="inst-row"><div class="inst-icon">üíæ</div><div class="inst-text txt-solo-save">Progress is saved in Slots.</div></div>
                <div class="inst-row"><div class="inst-icon">üÜô</div><div class="inst-text txt-solo-upg">Unit upgrades are kept between levels!</div></div>
                <div class="inst-row"><div class="inst-icon">‚≠ê</div><div class="inst-text txt-solo-star">Win levels -> Get Stars -> Unlock Passive Skills.</div></div>
                <div class="inst-row"><div class="inst-icon">üíÄ</div><div class="inst-text txt-solo-loss">If you lose, you retry the level.</div></div>
            </div>

            <!-- TAB: MULTI -->
            <div id="inst-content-multi" class="inst-content">
                <div class="inst-row"><div class="inst-icon">üéÆ</div><div class="inst-text txt-multi-local">Local PvP: 2 Players on 1 Device.</div></div>
                <div class="inst-row"><div class="inst-icon">üì±</div><div class="inst-text txt-multi-split">P1 on Left, P2 on Right.</div></div>
                <div class="inst-row"><div class="inst-icon">üÉè</div><div class="inst-text txt-multi-draft">War Council: Players take turns picking cards.</div></div>
                <div class="inst-row"><div class="inst-icon">‚öñÔ∏è</div><div class="inst-text txt-multi-fair">Fair start: Same stats for both.</div></div>
            </div>
        </div>
        
        <div class="btn-generic txt-back" onclick="showMainMenu()">BACK</div>
    </div>
    
    <!-- CUSTOM MODAL -->
    <div id="custom-modal">
        <div class="modal-box">
            <p id="modal-msg" style="margin-bottom:3vh; line-height: 1.5; font-size: 1.8vh;">ARE YOU SURE?</p>
            <div style="display:flex; gap:2vh; justify-content:center;">
                <button id="modal-yes" class="btn-generic" style="width:auto; margin:0; border-color:#f55;">YES</button>
                <button id="modal-no" class="btn-generic" style="width:auto; margin:0;">NO</button>
            </div>
        </div>
    </div>

           <div id="game-over-screen" onclick="handleGameOverClick()">
        <h1 id="winner-text" style="font-size: 6vh; margin-bottom: 20px;">VICTORY</h1>
        <div id="stats-container"></div>
        <p id="game-over-subtext" style="font-size: 2vh; animation: blink 1s infinite; margin-top: 20px;" class="txt-exit-tap">TAP TO RETURN TO MENU</p>
    </div>

    <div id="dice-modal">
        <div class="dice-box" id="dice-step-1">
            <div class="section-title" style="color:#ffd700; font-size:2.5vh">TREASURE CHANCE</div>
            <div style="color:#ccc; font-size:1.5vh; margin-bottom:2vh">GUESS: HIGH (4-6) or LOW (1-3)?</div>
            <div class="dice-display" id="dice-anim">üé≤</div>
            <div style="display:flex; gap:2vh; justify-content:center;">
                <button class="btn-generic" onclick="playDice('LOW')" style="border-color:#44f; color:#aaf;">LOW (1-3)</button>
                <button class="btn-generic" onclick="playDice('HIGH')" style="border-color:#f44; color:#faa;">HIGH (4-6)</button>
            </div>
            <div class="btn-generic" onclick="closeDiceGame()" style="margin-top:2vh; font-size:1.5vh; padding:1vh;">SKIP</div>
        </div>

        <div class="dice-box treasure-reveal" id="dice-step-2">
            <div class="section-title" id="dice-result-title" style="color:#0f0">WIN!</div>
            <div id="dice-result-msg" style="color:#fff; font-size:2vh;">Dice: 6</div>
    
            <div id="reward-content">
                <div class="treasure-icon" id="reward-icon">üéÅ</div>
                <div class="treasure-name" id="reward-name">ITEM NAME</div>
                <div class="treasure-desc" id="reward-desc">Description here.</div>
            </div>

            <button class="btn-generic" onclick="closeDiceGame()">CONTINUE</button>
        </div>
    </div>

<script>
(function() {
    if (window.pixelGameCleanup) window.pixelGameCleanup();

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let animationId; let lastTime = 0;
    let scaleRatio = 1; let renderScale = 1; 
    let currentLang = 'zh-TW';

    // --- SAVE SYSTEM V2 (PER-SLOT META) ---
    const SAVE_PREFIX = 'warriors_v2_slot_';
    let currentSlotId = 1;
    let currentSlotData = null; // { meta: {stars, skills}, run: {level, stats...} }
    let currentLoop = 0;


    function getEmptySlotData() {
        return {
            meta: { 
                stars: 0, 
                skills: {},
                // Êñ∞Â¢ûÔºöÂØ∂Áâ©Êî∂ÈõÜÂÜä (ÂÑ≤Â≠òÂ∑≤Áç≤ÂæóÁöÑÂØ∂Áâ© IDÔºå‰æãÂ¶Ç [1, 5, 12])
                collection: [] 
            }, 
            run: null, 
            lastPlayed: Date.now()
        };
    }

const TREASURES = [
        { id: 1, icon: 'üçû', name: { 'zh-TW': 'ÁôºÈúâÁöÑËªçÁ≥ß', 'en': 'Moldy Ration', 'ja': '„Ç´„Éì„ÅüÈ£üÁ≥ß' }, desc: { 'zh-TW': 'Á°¨ÂæóÂÉèÁü≥È†≠‰∏ÄÊ®£„ÄÇ', 'en': 'Hard as rock.', 'ja': 'Áü≥„ÅÆ„Çà„ÅÜ„Å´Á°¨„ÅÑ„ÄÇ' } },
        { id: 2, icon: 'üß¶', name: { 'zh-TW': 'Âπ∏ÈÅãÂ∑¶ËÖ≥Ë•™', 'en': 'Lucky Left Sock', 'ja': 'Âπ∏ÈÅã„ÅÆÈù¥‰∏ã' }, desc: { 'zh-TW': 'ÊìöË™™ËÉΩÂ∏∂‰æÜÂ•ΩÈÅãÔºü', 'en': 'Brings good luck?', 'ja': 'Âπ∏ÈÅã„ÇíÂëº„Å∂„Çâ„Åó„ÅÑÔºü' } },
        { id: 3, icon: 'üîß', name: { 'zh-TW': 'ÁîüÈèΩÁöÑÊùøÊâã', 'en': 'Rusty Wrench', 'ja': 'ÈåÜ„Å≥„Åü„É¨„É≥„ÉÅ' }, desc: { 'zh-TW': '‰øÆÁêÜÊàñÊòØÊï≤‰∫∫Áî®ÁöÑ„ÄÇ', 'en': 'For fixing or hitting.', 'ja': '‰øÆÁêÜÁî®„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÊÆ¥ÊâìÁî®„ÄÇ' } },
        { id: 4, icon: 'üìú', name: { 'zh-TW': 'ÊèâÁàõÁöÑÂú∞Âúñ', 'en': 'Crumpled Map', 'ja': '„Åè„Åó„ÇÉ„Åè„Åó„ÇÉ„ÅÆÂú∞Âõ≥' }, desc: { 'zh-TW': 'Ê≤í‰∫∫Áü•ÈÅìÁµÇÈªûÂú®Âì™„ÄÇ', 'en': 'Where does it lead?', 'ja': 'ÁõÆÁöÑÂú∞„ÅØ‰∏çÊòé„Å†„ÄÇ' } },
        { id: 5, icon: 'ü™µ', name: { 'zh-TW': 'Ë®ìÁ∑¥Áî®Êú®Âäç', 'en': 'Training Sword', 'ja': 'Ë®ìÁ∑¥Áî®„ÅÆÊú®Ââ£' }, desc: { 'zh-TW': 'ÊòÇË≤¥ÁöÑÊü¥ÁÅ´„ÄÇ', 'en': 'Expensive firewood.', 'ja': 'È´òÁ¥ö„Å™ÁÑö„ÅçÊú®„ÄÇ' } },
        { id: 6, icon: 'üè≥Ô∏è', name: { 'zh-TW': 'ÊäïÈôçÁôΩÊóó', 'en': 'White Flag', 'ja': 'Èôç‰ºè„ÅÆÁôΩÊóó' }, desc: { 'zh-TW': 'ÊèÆËàû‰∫ÜÂæàÂ§öÊ¨°„ÄÇ', 'en': 'Waved many times.', 'ja': '‰ΩïÂ∫¶„ÇÇÊåØ„Çâ„Çå„Åü„Çà„ÅÜ„Å†„ÄÇ' } },
        { id: 7, icon: 'üé∫', name: { 'zh-TW': 'ËÆäÂΩ¢ÁöÑËªçËôü', 'en': 'Bent Trumpet', 'ja': 'Êõ≤„Åå„Å£„Åü„É©„ÉÉ„Éë' }, desc: { 'zh-TW': 'ËÅ≤Èü≥ÂÉèÈ¥®Â≠êÂè´„ÄÇ', 'en': 'Sounds like a duck.', 'ja': '„Ç¢„Éí„É´„ÅÆ„Çà„ÅÜ„Å™Èü≥„Åå„Åô„Çã„ÄÇ' } },
        { id: 8, icon: 'üíç', name: { 'zh-TW': 'Áç∏‰∫∫ÁöÑÈºªÁí∞', 'en': 'Orc Ring', 'ja': '„Ç™„Éº„ÇØ„ÅÆÈºªËº™' }, desc: { 'zh-TW': 'Êúâ‰∏ÄËÇ°ÈêµÈèΩÂë≥„ÄÇ', 'en': 'Smells rusty.', 'ja': 'ÈâÑÈåÜ„ÅÆÂåÇ„ÅÑ„Åå„Åô„Çã„ÄÇ' } },
        { id: 9, icon: 'üè∫', name: { 'zh-TW': 'Á†¥ÊêçÁöÑÈô∂ÁΩê', 'en': 'Broken Pot', 'ja': 'Ââ≤„Çå„ÅüÂ£∫' }, desc: { 'zh-TW': 'Ë£°Èù¢ÊõæÁ∂ìÊúâÂØ∂Áü≥„ÄÇ', 'en': 'Had gems inside.', 'ja': 'Êòî„ÅØÂÆùÁü≥„ÅåÂÖ•„Å£„Å¶„ÅÑ„Åü„ÄÇ' } },
        { id: 10, icon: 'üìó', name: { 'zh-TW': 'Êñ∞ÂÖµÊó•Ë®ò', 'en': 'Rookie Diary', 'ja': 'Êñ∞ÂÖµ„ÅÆÊó•Ë®ò' }, desc: { 'zh-TW': 'ÊàëÊÉ≥ÂõûÂÆ∂...', 'en': 'I wanna go home...', 'ja': '„Äå„ÅäÂÆ∂„Å´Â∏∞„Çä„Åü„ÅÑ...„Äç' } },
        { id: 11, icon: 'üëë', name: { 'zh-TW': 'Âì•Â∏ÉÊûóÁéãÂÜ†', 'en': 'Goblin Crown', 'ja': '„Ç¥„Éñ„É™„É≥„ÅÆÁéãÂÜ†' }, desc: { 'zh-TW': 'ÊòìÈñãÁΩêÊãâÁí∞ÂÅöÁöÑ„ÄÇ', 'en': 'Made of tabs.', 'ja': 'Á©∫„ÅçÁº∂„ÅÆ„Éó„É´„Çø„ÉñË£Ω„ÄÇ' } },
        { id: 12, icon: 'üó°Ô∏è', name: { 'zh-TW': 'Êñ∑Ë£ÇÂãáËÄÖÂäç', 'en': 'Broken Sword', 'ja': 'Êäò„Çå„ÅüÂãáËÄÖ„ÅÆÂâ£' }, desc: { 'zh-TW': '‰æùÁÑ∂Êï£ÁôºÂæÆÂÖâ„ÄÇ', 'en': 'Still glowing.', 'ja': '„Åæ„Å†ÂæÆ„Åã„Å´ÂÖâ„Å£„Å¶„ÅÑ„Çã„ÄÇ' } },
        { id: 13, icon: 'üõ°Ô∏è', name: { 'zh-TW': 'ÈæçÈ±óÁõæÁ¢éÁâá', 'en': 'Scale Fragment', 'ja': 'Á´ú„ÅÆÈ±ó„ÅÆÊ¨†Áâá' }, desc: { 'zh-TW': 'ÁúãËµ∑‰æÜÂÉèÂ°ëËÜ†„ÄÇ', 'en': 'Looks plastic.', 'ja': '„Éó„É©„Çπ„ÉÅ„ÉÉ„ÇØ„Å´Ë¶ã„Åà„Çã„ÄÇ' } },
        { id: 14, icon: 'üíé', name: { 'zh-TW': 'ÊôÇÂÖâÂØ∂Áü≥', 'en': 'Time Gem', 'ja': 'ÊôÇ„ÅÆÂÆùÁü≥' }, desc: { 'zh-TW': '‰∏ä‰∏ÄÈóúÂâõÊâìÈÅéÔºü', 'en': 'D√©j√† vu?', 'ja': '„Éá„Ç∏„É£„É¥„ÇíÊÑü„Åò„ÇãÔºü' } },
        { id: 15, icon: 'üßß', name: { 'zh-TW': 'ÊïµÂ∞áÁ¥ÖÂåÖË¢ã', 'en': 'Red Envelope', 'ja': 'ÊïµÂ∞Ü„ÅÆ„ÅäÂπ¥Áéâ' }, desc: { 'zh-TW': 'Ë£°Èù¢Ë£ùËëóÊî∂Êìö„ÄÇ', 'en': 'Full of receipts.', 'ja': '‰∏≠Ë∫´„ÅØ„É¨„Ç∑„Éº„Éà„Å†„ÄÇ' } },
        { id: 16, icon: 'üëæ', name: { 'zh-TW': 'ÊúÄÂàùÁöÑÂÉèÁ¥†', 'en': 'First Pixel', 'ja': 'Âßã„Åæ„Çä„ÅÆ„Éî„ÇØ„Çª„É´' }, desc: { 'zh-TW': '‰∏ñÁïåÁöÑÁ¨¨‰∏ÄÂÄãÈªû„ÄÇ', 'en': 'The origin point.', 'ja': 'ÂÖ®„Å¶„ÅØ„Åì„Åì„Åã„ÇâÂßã„Åæ„Å£„Åü„ÄÇ' } },
        { id: 17, icon: 'üíæ', name: { 'zh-TW': 'ÈÅ†Âè§Á£ÅÁ¢üÁâá', 'en': 'Ancient Floppy', 'ja': 'Âè§‰ª£„ÅÆ„Éï„É≠„ÉÉ„Éî„Éº' }, desc: { 'zh-TW': 'Save_Final_v2', 'en': 'Save_Final_v2', 'ja': 'Save_Final_v2' } },
        { id: 18, icon: 'üé≤', name: { 'zh-TW': 'ÁÅåÈâõÈ™∞Â≠ê', 'en': 'Loaded Dice', 'ja': '„Ç§„Ç´„Çµ„Éû„Çµ„Ç§„Ç≥„É≠' }, desc: { 'zh-TW': 'ËéäÂÆ∂Á∏ΩÊòØË¥è„ÄÇ', 'en': 'House always wins.', 'ja': 'ËÉ¥ÂÖÉ„ÅØÂ∏∏„Å´Âãù„Å§„ÄÇ' } },
        { id: 19, icon: 'üêõ', name: { 'zh-TW': 'Ë¢´‰øÆÂæ©ÁöÑËü≤', 'en': 'Squashed Bug', 'ja': '‰øÆÊ≠£„Åï„Çå„Åü„Éê„Ç∞' }, desc: { 'zh-TW': 'ÊÑüË¨ùÁ®ãÂºèË®≠Ë®àÂ∏´„ÄÇ', 'en': 'Thanks coder.', 'ja': '„Éó„É≠„Ç∞„É©„Éû„Éº„Å´ÊÑüË¨ù„ÄÇ' } },
        { id: 20, icon: 'üèÜ', name: { 'zh-TW': 'Ëá≥È´òÁçéÁõÉ', 'en': 'The Grail', 'ja': 'Ëá≥È´ò„ÅÆ„Éà„É≠„Éï„Ç£„Éº' }, desc: { 'zh-TW': 'Áµ¶ÁúüÊ≠£ÁöÑÊî∂ËóèÂÆ∂„ÄÇ', 'en': 'For collectors.', 'ja': 'Áúü„ÅÆÂèéÈõÜÂÆ∂„Å∏„ÄÇ' } }
    ];

// --- üèÜ ÂØ∂Áâ©Â∫´Á≥ªÁµ± ---
    window.showTreasury = function() {
        SoundManager.playButton();
        hideAllMenus();
        document.getElementById('treasury-menu').style.display = 'flex';
        renderTreasury();
    };

   window.renderTreasury = function() {
    const grid = document.getElementById('treasure-grid');
    grid.innerHTML = '';

    const collection = (currentSlotData && currentSlotData.meta.collection) ? currentSlotData.meta.collection : [];

    TREASURES.forEach(t => {
        const isUnlocked = collection.includes(t.id);
        const el = document.createElement('div');
        el.className = `t-item ${isUnlocked ? 'unlocked' : 'locked'}`;
        el.innerHTML = isUnlocked ? t.icon : '?';

        el.onclick = () => {
            SoundManager.playButton();
            document.querySelectorAll('.t-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');

            // ËÆÄÂèñÁï∂ÂâçË™ûË®ÄÊñáÂ≠ó
            const itemName = t.name[currentLang] || t.name['en'];
            const itemDesc = t.desc[currentLang] || t.desc['en'];

            if (isUnlocked) {
                document.getElementById('t-detail-icon').innerText = t.icon;
                document.getElementById('t-detail-name').innerText = itemName;
                document.getElementById('t-detail-desc').innerText = itemDesc;
                document.getElementById('t-detail-desc').style.color = "#aaa";
            } else {
                document.getElementById('t-detail-icon').innerText = "üîí";
                document.getElementById('t-detail-name').innerText = TEXT[currentLang]['T_LOCKED']; // ‰ΩøÁî®Â§öË™ûË®Ä
                document.getElementById('t-detail-desc').innerText = TEXT[currentLang]['T_HINT'];   // ‰ΩøÁî®Â§öË™ûË®Ä
                document.getElementById('t-detail-desc').style.color = "#666";
            }
            };
            grid.appendChild(el);
        });
    };

// --- üé≤ È™∞Â≠êËàáÂØ∂Áâ©Á≥ªÁµ±ÈÇèËºØ ---
    window.showDiceGame = function() {
        document.getElementById('dice-modal').style.display = 'flex';
        document.getElementById('dice-step-1').style.display = 'block';
        document.getElementById('dice-step-2').style.display = 'none';
        document.getElementById('dice-anim').innerText = "üé≤";
    };

    window.playDice = function(guess) {
        const diceVal = Math.floor(Math.random() * 6) + 1; // 1-6
        const isLow = diceVal <= 3;
        const isWin = (guess === 'LOW' && isLow) || (guess === 'HIGH' && !isLow);
        
        document.getElementById('dice-step-1').style.display = 'none';
        document.getElementById('dice-step-2').style.display = 'flex';
        
        const title = document.getElementById('dice-result-title');
        const msg = document.getElementById('dice-result-msg');
        msg.innerText = `Dice: ${diceVal} (${diceVal<=3?'LOW':'HIGH'})`;

        if (isWin) {
            SoundManager.playLevelUp();
            title.innerText = "YOU GUESSED RIGHT!";
            title.style.color = "#0f0";
            
            const treasure = unlockRandomTreasure();
            if (treasure) {
                document.getElementById('reward-icon').innerText = treasure.icon;
                document.getElementById('reward-name').innerText = treasure.name[currentLang];
                document.getElementById('reward-desc').innerText = treasure.desc[currentLang];
            } else {
                // ÂÖ®ÈÉ®Êî∂ÈõÜÊªø‰∫Ü
                document.getElementById('reward-icon').innerText = "üèÜ";
                document.getElementById('reward-name').innerText = "ALL COLLECTED!";
                document.getElementById('reward-desc').innerText = "You are the master of war.";
            }
        } else {
            SoundManager.playHit();
            title.innerText = "WRONG GUESS...";
            title.style.color = "#f44";
            
            // ÂÆâÊÖ∞Áçé
            document.getElementById('reward-icon').innerText = "‚ö°";
            document.getElementById('reward-name').innerText = "ENERGY +10";
            document.getElementById('reward-desc').innerText = "Better luck next time.";
            p1.energy += 10; // Áµ¶‰∏ÄÈªû‰∏ã‰∏ÄÈóúÁöÑÂÑ™Âã¢
        }
    };

    window.closeDiceGame = function() {
        document.getElementById('dice-modal').style.display = 'none';
        startGame(true); // ÈÄ≤ÂÖ•‰∏ã‰∏ÄÈóú
    };

    function unlockRandomTreasure() {
        if (!currentSlotData) return null;
        if (!currentSlotData.meta.collection) currentSlotData.meta.collection = [];
        
        let playerCollection = currentSlotData.meta.collection;
        let unowned = TREASURES.filter(t => !playerCollection.includes(t.id));

        if (unowned.length === 0) return null;

        const newItem = unowned[Math.floor(Math.random() * unowned.length)];
        currentSlotData.meta.collection.push(newItem.id);
        saveCurrentSlot();
        return newItem;
    }
    function getSlotData(id) {
        try {
            const json = localStorage.getItem(SAVE_PREFIX + id);
            return json ? JSON.parse(json) : null;
        } catch(e) { return null; }
    }

    function saveCurrentSlot() {
        if(!currentSlotId || !currentSlotData) return;
        localStorage.setItem(SAVE_PREFIX + currentSlotId, JSON.stringify(currentSlotData));
    }

    // --- MENU ENTITIES ---
    let menuEntities = []; let menuScroll = 0;
    function initMenuEntities() {
        menuEntities = [];
        for(let i=0; i<15; i++) menuEntities.push({ type: 'RUNNER', x: Math.random() * w, y: h * (0.6 + Math.random() * 0.3), speed: 200 + Math.random() * 150, unitType: Object.values(UNIT_TYPES)[Math.floor(Math.random()*3)], animFrame: Math.random() * 10 });
        for(let i=0; i<30; i++) menuEntities.push({ type: 'DUST', x: Math.random() * w, y: h * (0.6 + Math.random() * 0.3), vx: -100 - Math.random() * 100, vy: -20 - Math.random() * 30, life: Math.random(), size: 2 + Math.random() * 4 });
    }

    // --- EXPANDED SKILL TREE (UNLIMITED LEVELS) ---
    const SKILL_TREE = [
        // ROOT
        { id: 'recruit', icon: '‚≠êÔ∏è', cost: 1, name: {'zh-TW':'Êñ∞ÂÖµË®ìÁ∑¥','en':'RECRUIT','ja':'Êñ∞ÂÖµË®ìÁ∑¥'}, desc: {'zh-TW':'ÂÖ®ÂñÆ‰ΩçÁîüÂëΩ +5% /Á¥ö','en':'All HP +5% /Lv','ja':'ÂÖ®HP+5% /Lv'}, 
          effect: (p, lvl) => { p.stats.swordHp+=0.05*lvl; p.stats.spearHp+=0.05*lvl; p.stats.axeHp+=0.05*lvl; }, x: 50, y: 10, parent: null },
        
        // LEFT BRANCH (OFFENSE)
        { id: 'swordsman', icon: '‚öîÔ∏è', cost: 1, name: {'zh-TW':'ÂäçË°ìÂÖ•ÈñÄ','en':'SWORDSMAN','ja':'Ââ£Ë°ìÂÖ•ÈñÄ'}, desc: {'zh-TW':'ÂäçÂÖµÂÇ∑ÂÆ≥ +10% /Á¥ö','en':'Sword Dmg +10% /Lv','ja':'Ââ£ÂÖµÊîª+10% /Lv'}, 
          effect: (p, lvl)=>p.stats.swordDmg+=0.1*lvl, x: 30, y: 25, parent: 'recruit' },
        { id: 'warrior', icon: 'ü™ì', cost: 1, name: {'zh-TW':'Êà∞Â£´Ë®ìÁ∑¥','en':'WARRIOR','ja':'Êà¶Â£´Ë®ìÁ∑¥'}, desc: {'zh-TW':'ÊñßÂÖµÂÇ∑ÂÆ≥ +10% /Á¥ö','en':'Axe Dmg +10% /Lv','ja':'ÊñßÂÖµÊîª+10% /Lv'}, 
          effect: (p, lvl)=>p.stats.axeDmg+=0.1*lvl, x: 15, y: 35, parent: 'swordsman' },
        { id: 'fencer', icon: 'ü§∫', cost: 2, name: {'zh-TW':'ÂäçËàûËÄÖ','en':'FENCER','ja':'„Éï„Çß„É≥„Çµ„Éº'}, desc: {'zh-TW':'ÂäçÂÖµÈÄüÂ∫¶ +5% /Á¥ö','en':'Sword Spd +5% /Lv','ja':'Ââ£ÂÖµÈÄü+5% /Lv'}, 
          effect: (p, lvl)=>p.stats.swordSpd+=0.05*lvl, x: 30, y: 45, parent: 'swordsman' },
        { id: 'berserker', icon: 'üò°', cost: 2, name: {'zh-TW':'ÁãÇÊà∞Â£´','en':'BERSERKER','ja':'„Éê„Éº„Çµ„Éº„Ç´„Éº'}, desc: {'zh-TW':'ÊñßÂÖµÈÄüÂ∫¶ +5% /Á¥ö','en':'Axe Spd +5% /Lv','ja':'ÊñßÂÖµÈÄü+5% /Lv'}, 
          effect: (p, lvl)=>p.stats.axeSpd+=0.05*lvl, x: 15, y: 55, parent: 'warrior' },
        { id: 'sword_master', icon: 'üó°Ô∏è', cost: 3, name: {'zh-TW':'ÂäçËÅñ','en':'SWORD MASTER','ja':'Ââ£ËÅñ'}, desc: {'zh-TW':'ÂäçÂÖµÂÇ∑ÂÆ≥ +20% /Á¥ö','en':'Sword Dmg +20% /Lv','ja':'Ââ£ÂÖµÊîª+20% /Lv'}, 
          effect: (p, lvl)=>p.stats.swordDmg+=0.2*lvl, x: 30, y: 65, parent: 'fencer' },
        { id: 'axe_lord', icon: 'üëπ', cost: 3, name: {'zh-TW':'Êà∞Á•û','en':'WAR GOD','ja':'Êà¶Á•û'}, desc: {'zh-TW':'ÊñßÂÖµÁîüÂëΩ +20% /Á¥ö','en':'Axe HP +20% /Lv','ja':'ÊñßÂÖµHP+20% /Lv'}, 
          effect: (p, lvl)=>p.stats.axeHp+=0.2*lvl, x: 15, y: 75, parent: 'berserker' },

        // RIGHT BRANCH (DEFENSE)
        { id: 'guardsman', icon: 'üõ°Ô∏è', cost: 1, name: {'zh-TW':'ÂÆàË°õË®ìÁ∑¥','en':'GUARDSMAN','ja':'ÂÆàË°õË®ìÁ∑¥'}, desc: {'zh-TW':'ÊßçÂÖµÁîüÂëΩ +10% /Á¥ö','en':'Spear HP +10% /Lv','ja':'ÊßçÂÖµHP+10% /Lv'}, 
          effect: (p, lvl)=>p.stats.spearHp+=0.1*lvl, x: 70, y: 25, parent: 'recruit' },
        { id: 'fortification', icon: 'üß±', cost: 1, name: {'zh-TW':'Âä†Âõ∫Â∑•‰∫ã','en':'FORTIFY','ja':'Èò≤Â£ÅÂº∑Âåñ'}, desc: {'zh-TW':'Âü∫Âú∞ÁîüÂëΩ +500 /Á¥ö','en':'Base HP +500 /Lv','ja':'Âü∫Âú∞HP+500 /Lv'}, 
          effect: (p, lvl)=>p.baseHealth+=500*lvl, x: 85, y: 35, parent: 'guardsman' },
        { id: 'phalanx', icon: 'üî±', cost: 2, name: {'zh-TW':'ÊñπÈô£Èï∑Êßç','en':'PHALANX','ja':'„Éï„Ç°„É©„É≥„ÇØ„Çπ'}, desc: {'zh-TW':'ÊßçÂÖµÂÇ∑ÂÆ≥ +10% /Á¥ö','en':'Spear Dmg +10% /Lv','ja':'ÊßçÂÖµÊîª+10% /Lv'}, 
          effect: (p, lvl)=>p.stats.spearDmg+=0.1*lvl, x: 70, y: 45, parent: 'guardsman' },
        { id: 'castle_wall', icon: 'üè∞', cost: 3, name: {'zh-TW':'ÈãºÈêµÂ†°Â£ò','en':'IRON CASTLE','ja':'ÈâÑ„ÅÆÂüé'}, desc: {'zh-TW':'Âü∫Âú∞ÁîüÂëΩ +1000 /Á¥ö','en':'Base HP +1000 /Lv','ja':'Âü∫Âú∞HP+1000 /Lv'}, 
          effect: (p, lvl)=>p.baseHealth+=1000*lvl, x: 85, y: 55, parent: 'fortification' },
        { id: 'spear_legend', icon: 'üéñÔ∏è', cost: 3, name: {'zh-TW':'ÂÇ≥Â•áÊßçÂÖµ','en':'LEGENDARY','ja':'‰ºùË™¨„ÅÆÊßç'}, desc: {'zh-TW':'ÊßçÂÖµÁîüÂëΩ +20% /Á¥ö','en':'Spear HP +20% /Lv','ja':'ÊßçÂÖµHP+20% /Lv'}, 
          effect: (p, lvl)=>p.stats.spearHp+=0.2*lvl, x: 70, y: 65, parent: 'phalanx' },

        // MIDDLE BRANCH (ECONOMY)
        { id: 'logistics', icon: 'üì¶', cost: 2, name: {'zh-TW':'ÂæåÂã§Â≠∏','en':'LOGISTICS','ja':'ÂÖµÁ´ôÂ≠¶'}, desc: {'zh-TW':'ËÉΩÈáèÂõûÂæ© +5% /Á¥ö','en':'Energy +5% /Lv','ja':'Ê¥ªÂäõ+5% /Lv'}, 
          effect: (p, lvl)=>p.stats.energyRate+=0.05*lvl, x: 50, y: 30, parent: 'recruit' },
        { id: 'supply_lines', icon: 'üöö', cost: 2, name: {'zh-TW':'Ë£úÁµ¶Á∑ö','en':'SUPPLY','ja':'Ë£úÁµ¶Á∑ö'}, desc: {'zh-TW':'ËÉΩÈáèÂõûÂæ© +10% /Á¥ö','en':'Energy +10% /Lv','ja':'Ê¥ªÂäõ+10% /Lv'}, 
          effect: (p, lvl)=>p.stats.energyRate+=0.1*lvl, x: 50, y: 50, parent: 'logistics' },
        { id: 'industrial', icon: 'üè≠', cost: 3, name: {'zh-TW':'Â∑•Ê•≠Âåñ','en':'INDUSTRY','ja':'Â∑•Ê•≠Âåñ'}, desc: {'zh-TW':'ËÉΩÈáèÂõûÂæ© +15% /Á¥ö','en':'Energy +15% /Lv','ja':'Ê¥ªÂäõ+15% /Lv'}, 
          effect: (p, lvl)=>p.stats.energyRate+=0.15*lvl, x: 50, y: 70, parent: 'supply_lines' },
        { id: 'general', icon: 'üëë', cost: 5, name: {'zh-TW':'Â∏ùÂúãÊôÇ‰ª£','en':'EMPIRE','ja':'Â∏ùÂõΩÊôÇ‰ª£'}, desc: {'zh-TW':'ÂÖ®ÂñÆ‰ΩçÂÖ®Â±¨ÊÄß +5% /Á¥ö','en':'All Stats +5% /Lv','ja':'ÂÖ®„Çπ„ÉÜ+5% /Lv'}, 
          effect: (p, lvl)=>{ const b=0.05*lvl; p.stats.swordDmg+=b; p.stats.swordHp+=b; p.stats.swordSpd+=b; p.stats.spearDmg+=b; p.stats.spearHp+=b; p.stats.spearSpd+=b; p.stats.axeDmg+=b; p.stats.axeHp+=b; p.stats.axeSpd+=b; }, x: 50, y: 90, parent: 'industrial' }
    ];

    // --- GAME CONSTANTS ---
    const GAME_STATE = { MENU: 0, CAMPAIGN_MENU: 1, SLOT_LOBBY: 2, MAP_SELECT: 3, PLAYING: 4, GAMEOVER: 5, INSTRUCTIONS: 6, UPGRADE: 7, SKILL_TREE: 8 };
    let currentState = GAME_STATE.MENU;
    let gameMode = 'CAMPAIGN'; let currentMapKey = 'GRASS'; let currentLevel = 1;
    const MAX_LEVELS = 10; const UPGRADE_INTERVAL = 30;

    const UNIT_TYPES = {
        SWORD: { id: 0, color: '#ff4444', icon: '‚öîÔ∏è', name: 'SWORD' },
        SPEAR: { id: 1, color: '#4444ff', icon: 'üî±', name: 'SPEAR' },
        AXE:   { id: 2, color: '#44ff44', icon: 'ü™ì', name: 'AXE' }
    };
    
    // --- TEXT & LOCALIZATION (UPDATED) ---
    const TEXT = {
        'zh-TW': {
            TITLE: "Warriors!\nGO! GO! GO!", SOLO_TITLE: "ÂñÆ‰∫∫ÂÇ≥Ë™™", SOLO_DESC: "Roguelike Ê®°Âºè", MULTI_TITLE: "Èõô‰∫∫Â∞çÊ±∫", MULTI_DESC: "Êú¨Ê©üÈõô‰∫∫Â∞çÊà∞", INSTRUCT_BTN: "ÈÅäÊà≤Ë™™Êòé", CREDITS: "¬© 2025 PIXEL STUDIO", BACK: "ËøîÂõû", MAP_TITLE: "ÈÅ∏ÊìáÊà∞Â†¥", MAP_GRASS: "Áø†Á∂†Âπ≥Âéü", MAP_LAVA: "ÁÜîÂ≤©ËçíÂéü", MAP_SNOW: "Ê•µÂú∞ÂáçÂúü", INST_TITLE: "Êà∞È¨•ÊåáÂçó", COUNCIL_TITLE: "Êà∞Áà≠Ë≠∞ÊúÉ", P1_ENERGY: "P1 ËÉΩÈáè", P2_ENERGY: "P2 ËÉΩÈáè", NO_ENERGY: "ËÉΩÈáè‰∏çË∂≥", CRIT: "ÁàÜÊìä!", WEAK: "ËôõÂº±", VICTORY: "ÂãùÂà©ÔºÅ", DEFEAT: "Â§±Êïó...", P1_WINS: "P1 Áç≤ÂãùÔºÅ", P2_WINS: "P2 Áç≤ÂãùÔºÅ", STAT_SPAWNED: "Ê¥æÈÅ£ÂñÆ‰Ωç", STAT_DAMAGE: "ÈÄ†ÊàêÂÇ∑ÂÆ≥", STAT_KILLS: "ÊìäÊÆ∫Êï∏", STAT_PERKS: "Âº∑ÂåñÊ¨°Êï∏", STAGE: "ÈóúÂç°", NEXT_STAGE_TAP: "ÈªûÊìäÈÄ≤ÂÖ•‰∏ã‰∏ÄÈóú", CAMPAIGN_WIN: "ÈÄöÈóúÈú∏Ê•≠ÔºÅ", FAV_UNIT: "ÊúÄÊÑõÂÖµÁ®Æ", NEW_GAME: "Êñ∞ÈÅäÊà≤", EMPTY_SLOT: "Á©∫Â≠òÊ™î", SLOT: "Â≠òÊ™î", CONFIRM_DELETE: "Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÂ≠òÊ™îÂóéÔºüÊäÄËÉΩÊ®π‰πüÊúÉË¢´ÈáçÁΩÆ„ÄÇ", SKILL_TREE: "ÊäÄËÉΩÊ®π", SKILL_TITLE: "ÊäÄËÉΩÊ®π", EXIT_TAP: "ÈªûÊìäËøîÂõû", SWORD: "ÂäçÂÖµ", AXE: "ÊñßÂÖµ", SPEAR: "ÊßçÂÖµ", LEVEL_PREFIX: "ÈóúÂç°", EXIT: "Èõ¢Èñã", CONTINUE: "ÁπºÁ∫å", LOBBY_TITLE: "Ê∫ñÂÇôÊà∞È¨•", START_BATTLE: "ÈñãÂßãÊà∞È¨•", STRONG_VS: "ÂâãÂà∂",
            // Treasury & New Features
            BTN_TREASURY: "Êà∞Âà©ÂìÅ", T_TITLE: "Êà∞Âà©ÂìÅÂØ∂Â∫´", T_SELECT: "ÈÅ∏Êìá‰∏ÄÂÄãÂØ∂Áâ©", T_DESC_DEFAULT: "Êî∂ÈõÜÊà∞Âà©ÂìÅ‰ª•Â°´ÊªøÊû∂Â≠ê„ÄÇ", T_LOCKED: "Êú™Ëß£Èéñ", T_HINT: "ÊìäÊïóÊïµ‰∫∫‰ª•ÁôºÁèæÊ≠§ÂØ∂Áâ©„ÄÇ",
            // Updated Instructions
            TAB_BASIC: "Âü∫Á§é", TAB_SOLO: "ÂñÆ‰∫∫", TAB_MULTI: "Â∞çÊà∞",
            BASIC_GOAL: "ÁõÆÊ®ôÔºöÊëßÊØÄÊïµÊñπÂ†°Â£ò„ÄÇ", 
            BASIC_CTRL: "Êìç‰ΩúÔºöÈªûÊìäË∑ØÂæëÊ¥æÈÅ£Â∞çÊáâÂÖµÁ®Æ„ÄÇ", 
            BASIC_ENERGY: "ËÉΩÈáèÔºöÂè¨ÂñöÊ∂àËÄóËÉΩÈáèÔºåÈö®ÊôÇÈñìÊÅ¢Âæ©„ÄÇ",
            SOLO_CAMP: "ÈóñÈóúÔºö10ÂÄãÈóúÂç° + ÁÑ°ÈôêËº™Ëø¥Èõ£Â∫¶„ÄÇ", 
            SOLO_SAVE: "ÈÄ≤Â∫¶ÔºöËá™ÂãïÂ≠òÊ™îÔºå‰øùÁïôÊäÄËÉΩËàáÊà∞Âà©ÂìÅ„ÄÇ", 
            SOLO_UPG: "ÁπºÊâøÔºöÂñÆÊ¨°ÂÜíÈö™‰∏≠ÁöÑÂº∑Âåñ‰øùÁïôËá≥‰∏ãÈóú„ÄÇ", 
            SOLO_STAR: "ÁçéÂãµÔºöÊî∂ÈõÜÊòüÊòüÂçáÁ¥öÊäÄËÉΩÔºåÁç≤ÂãùË¥èÂèñÊà∞Âà©ÂìÅÔºÅ", 
            SOLO_LOSS: "Â§±ÊïóÔºöË©≤ÈóúÂç°Èáç‰æÜÔºå‰ΩÜ‰øùÁïôÊäÄËÉΩ„ÄÇ",
            MULTI_LOCAL: "Â∞çÊà∞ÔºöÂêå‰∏ÄË£ùÁΩÆÔºåÈù¢Â∞çÈù¢ÈÅäÁé©„ÄÇ", 
            MULTI_SPLIT: "Áï´Èù¢ÔºöÂ∑¶ÂÅ¥ P1ÔºåÂè≥ÂÅ¥ P2„ÄÇ", 
            MULTI_DRAFT: "Ë≠∞ÊúÉÔºöÈõôÊñπËº™ÊµÅÈÅ∏ÊìáÂº∑ÂåñÂç°Áâå„ÄÇ", 
            MULTI_FAIR: "ÂÖ¨Âπ≥ÔºöÈõôÊñπËµ∑ÂßãËÉΩÂäõÂÆåÂÖ®Áõ∏Âêå„ÄÇ"
        },
        'en': {
            TITLE: "Warriors!\nGO! GO! GO!", SOLO_TITLE: "CAMPAIGN", SOLO_DESC: "Stage Mode.", MULTI_TITLE: "VS DUEL", MULTI_DESC: "Local PvP Battle", INSTRUCT_BTN: "INSTRUCTIONS", CREDITS: "¬© 2025 PIXEL STUDIO", BACK: "BACK", MAP_TITLE: "SELECT BATTLEFIELD", MAP_GRASS: "GREEN FIELDS", MAP_LAVA: "MOLTEN CORE", MAP_SNOW: "FROZEN PEAKS", INST_TITLE: "BATTLE GUIDE", COUNCIL_TITLE: "WAR COUNCIL", P1_ENERGY: "P1 ENERGY", P2_ENERGY: "P2 ENERGY", NO_ENERGY: "NO ENERGY", CRIT: "CRIT!", WEAK: "Weak", VICTORY: "VICTORY!", DEFEAT: "DEFEAT...", P1_WINS: "P1 WINS!", P2_WINS: "P2 WINS!", STAT_SPAWNED: "Units Spawned", STAT_DAMAGE: "Damage Dealt", STAT_KILLS: "Kills", STAT_PERKS: "Upgrades", STAGE: "STAGE", NEXT_STAGE_TAP: "TAP FOR NEXT STAGE", CAMPAIGN_WIN: "CAMPAIGN COMPLETE!", FAV_UNIT: "FAV UNIT", NEW_GAME: "NEW GAME", EMPTY_SLOT: "EMPTY SLOT", SLOT: "SLOT", CONFIRM_DELETE: "Delete save? Skill tree will reset.", SKILL_TREE: "SKILL TREE", SKILL_TITLE: "SKILL TREE", EXIT_TAP: "TAP TO RETURN", SWORD: "SWORD", AXE: "AXE", SPEAR: "SPEAR", LEVEL_PREFIX: "LEVEL", EXIT: "EXIT", CONTINUE: "CONTINUE", LOBBY_TITLE: "PREPARE", START_BATTLE: "START BATTLE", STRONG_VS: "Strong vs",
            // Treasury & New Features
            BTN_TREASURY: "TREASURY", T_TITLE: "WAR TROPHIES", T_SELECT: "SELECT A TREASURE", T_DESC_DEFAULT: "Collect trophies to fill this shelf.", T_LOCKED: "LOCKED", T_HINT: "Defeat enemies to discover.",
            // Updated Instructions
            TAB_BASIC: "BASIC", TAB_SOLO: "SOLO", TAB_MULTI: "VS",
            BASIC_GOAL: "Goal: Destroy Base.", 
            BASIC_CTRL: "Controls: Tap lanes to spawn units.", 
            BASIC_ENERGY: "Energy: Costs to spawn, regens over time.",
            SOLO_CAMP: "Campaign: 10 Stages + Infinite Loops.", 
            SOLO_SAVE: "Save: Progress & Treasures auto-saved.", 
            SOLO_UPG: "Keep: Upgrades carry over levels.", 
            SOLO_STAR: "Rewards: Stars for Skills, Dice Game for Loot!", 
            SOLO_LOSS: "Loss: Retry level, keep skills.",
            MULTI_LOCAL: "PvP: 2 Players on 1 Device.", 
            MULTI_SPLIT: "Split: P1 Left, P2 Right.", 
            MULTI_DRAFT: "Draft: Players take turns picking cards.", 
            MULTI_FAIR: "Fair: Equal start stats."
        },
        'ja': {
            TITLE: "Warriors!\nGO! GO! GO!", SOLO_TITLE: "Êà¶ÂΩπ„É¢„Éº„Éâ", SOLO_DESC: "„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢Âûã", MULTI_TITLE: "ÂØæÊà¶Ê±∫Èóò", MULTI_DESC: "„É≠„Éº„Ç´„É´PvPÂØæÊà¶", INSTRUCT_BTN: "ÈÅä„Å≥Êñπ", CREDITS: "¬© 2025 PIXEL STUDIO", BACK: "Êàª„Çã", MAP_TITLE: "Êà¶Â†¥ÈÅ∏Êäû", MAP_GRASS: "Á∑ë„ÅÆÂπ≥Âéü", MAP_LAVA: "Ê∫∂Â≤©„ÅÆËçíÈáé", MAP_SNOW: "Ê•µÂØí„ÅÆÂ≥∞", INST_TITLE: "Êà¶Èóò„Ç¨„Ç§„Éâ", COUNCIL_TITLE: "Êà¶‰∫â‰ºöË≠∞", P1_ENERGY: "P1 Ê¥ªÂäõ", P2_ENERGY: "P2 Ê¥ªÂäõ", NO_ENERGY: "Ê¥ªÂäõ‰∏çË∂≥", CRIT: "‰ºöÂøÉ!", WEAK: "ÂçäÊ∏õ", VICTORY: "ÂãùÂà©ÔºÅ", DEFEAT: "ÊïóÂåó...", P1_WINS: "P1 ÂãùÂà©ÔºÅ", P2_WINS: "P2 ÂãùÂà©ÔºÅ", STAT_SPAWNED: "Âá∫ÊíÉÊï∞", STAT_DAMAGE: "‰∏é„ÉÄ„É°", STAT_KILLS: "ÊíÉÁ†¥Êï∞", STAT_PERKS: "Âº∑ÂåñÊï∞", STAGE: "„Çπ„ÉÜ„Éº„Ç∏", NEXT_STAGE_TAP: "„Çø„ÉÉ„Éó„Åó„Å¶Ê¨°„Å∏", CAMPAIGN_WIN: "ÂÖ®„ÇØ„É™ÔºÅ", FAV_UNIT: "ÊÑõÁî®ÂÖµÁßë", NEW_GAME: "Êñ∞Ë¶è‰ΩúÊàê", EMPTY_SLOT: "Á©∫„Åç", SLOT: "„Éá„Éº„Çø", CONFIRM_DELETE: "ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Çπ„Ç≠„É´„ÇÇ„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ", SKILL_TREE: "„Çπ„Ç≠„É´„ÉÑ„É™„Éº", SKILL_TITLE: "„Çπ„Ç≠„É´„ÉÑ„É™„Éº", EXIT_TAP: "„Çø„ÉÉ„Éó„Åó„Å¶Êàª„Çã", SWORD: "Ââ£ÂÖµ", AXE: "ÊñßÂÖµ", SPEAR: "ÊßçÂÖµ", LEVEL_PREFIX: "Èù¢", EXIT: "ÈÄÄÂá∫", CONTINUE: "„Å§„Å•„Åç", LOBBY_TITLE: "Êà¶ÈóòÊ∫ñÂÇô", START_BATTLE: "Êà¶ÈóòÈñãÂßã", STRONG_VS: "ÊúâÂà©",
            // Treasury & New Features
            BTN_TREASURY: "ÂÆùÁâ©Â∫´", T_TITLE: "Êà¶Âà©ÂìÅ", T_SELECT: "ÂÆùÁâ©„ÇíÈÅ∏Êäû", T_DESC_DEFAULT: "ÂãùÂà©„Åó„Å¶Ê£ö„ÇíÂüã„ÇÅÂ∞Ω„Åè„Åù„ÅÜ„ÄÇ", T_LOCKED: "Êú™Ëß£Êòé", T_HINT: "Êïµ„ÇíÂÄí„Åó„Å¶Áô∫Ë¶ã„Åõ„Çà„ÄÇ",
            // Updated Instructions
            TAB_BASIC: "Âü∫Êú¨", TAB_SOLO: "‰∏Ä‰∫∫", TAB_MULTI: "ÂØæÊà¶",
            BASIC_GOAL: "ÁõÆÁöÑÔºöÊïµÂüéÁ†¥Â£ä„ÄÇ", 
            BASIC_CTRL: "Êìç‰ΩúÔºö„É¨„Éº„É≥„Çí„Çø„ÉÉ„Éó„Åó„Å¶Âá∫ÊíÉ„ÄÇ", 
            BASIC_ENERGY: "Ê¥ªÂäõÔºöÂè¨Âñö„Å´Ê∂àË≤ª„ÄÅÊôÇÈñì„ÅßÂõûÂæ©„ÄÇ",
            SOLO_CAMP: "Êà¶ÂΩπÔºöÂÖ®10Èù¢ Ôºã ÁÑ°Èôê„É´„Éº„Éó„É¢„Éº„Éâ„ÄÇ", 
            SOLO_SAVE: "‰øùÂ≠òÔºöÈÄ≤Ë°åÂ∫¶„Å®ÂÆùÁâ©„ÅØËá™Âãï‰øùÂ≠ò„ÄÇ", 
            SOLO_UPG: "Á∂ôÊâøÔºöÂº∑Âåñ„ÅØÊ¨°„ÅÆÈù¢„Å´ÊåÅ„Å°Ë∂ä„Åó„ÄÇ", 
            SOLO_STAR: "Â†±ÈÖ¨ÔºöÊòü„Åß„Çπ„Ç≠„É´Âº∑Âåñ„ÄÅ„Çµ„Ç§„Ç≥„É≠„ÅßÂÆùÁâ©ÂèéÈõÜÔºÅ", 
            SOLO_LOSS: "ÊïóÂåóÔºöÈù¢„É™„Éà„É©„Ç§„ÄÅ„Çπ„Ç≠„É´Á∂≠ÊåÅ„ÄÇ",
            MULTI_LOCAL: "ÂØæÊà¶Ôºö1Âè∞„ÅßÂêë„Åã„ÅÑÂêà„Å£„Å¶„Éó„É¨„Ç§„ÄÇ", 
            MULTI_SPLIT: "ÁîªÈù¢ÔºöÂ∑¶„ÅåP1„ÄÅÂè≥„ÅåP2„ÄÇ", 
            MULTI_DRAFT: "‰ºöË≠∞Ôºö‰∫§‰∫í„Å´Âº∑Âåñ„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„ÄÇ", 
            MULTI_FAIR: "ÂÖ¨Âπ≥ÔºöÂàùÊúü„Çπ„ÉÜ„Éº„Çø„Çπ„ÅØÂêå„Åò„ÄÇ"
        }
    };

    function t(key) { return TEXT[currentLang][key] || key; }
    window.setLanguage = function(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        if(lang==='zh-TW') document.querySelectorAll('.lang-btn')[0].classList.add('active');
        if(lang==='en') document.querySelectorAll('.lang-btn')[1].classList.add('active');
        if(lang==='ja') document.querySelectorAll('.lang-btn')[2].classList.add('active');
        updateUIText();
        if(currentState === GAME_STATE.CAMPAIGN_MENU) renderSaveSlots();
        if(currentState === GAME_STATE.SLOT_LOBBY) showSlotLobby();
    };

    function updateUIText() {
        const q = (s) => document.querySelector(s);
        const qa = (s) => document.querySelectorAll(s);
        const safeText = (sel, key) => { const el = q(sel); if(el) el.innerText = t(key); };
        const safeHTML = (sel, key) => { const el = q(sel); if(el) el.innerHTML = t(key).replace('\n','<br>'); };

        safeHTML('.txt-title', 'TITLE');
        qa('.txt-solo-title').forEach(e => e.innerText = t('SOLO_TITLE'));
        safeText('.txt-solo-desc', 'SOLO_DESC');
        safeText('.txt-multi-title', 'MULTI_TITLE');
        safeText('.txt-multi-desc', 'MULTI_DESC');
        safeText('.txt-instruct-btn', 'INSTRUCT_BTN');
        safeText('.txt-credits', 'CREDITS');
        qa('.txt-back').forEach(e => e.innerText = t('BACK'));
        safeText('.txt-skill-title', 'SKILL_TITLE');
        safeText('.btn-skill-tree', 'SKILL_TREE');
        safeText('.txt-inst-title', 'INST_TITLE');
        safeText('.txt-inst-tap', 'INST_TAP');
        safeText('.txt-inst-stars', 'INST_STARS');
        safeText('.txt-inst-slots', 'INST_SLOTS');
        safeText('.txt-council-title', 'COUNCIL_TITLE');
        safeText('.txt-exit-tap', 'EXIT_TAP');
        safeText('.txt-lobby-title', 'LOBBY_TITLE');
        safeText('.txt-start-battle', 'START_BATTLE');
        
        safeText('.txt-btn-treasury', 'BTN_TREASURY');
        safeText('.txt-t-title', 'T_TITLE');
        safeText('.txt-t-select', 'T_SELECT');
        safeText('.txt-t-desc-default', 'T_DESC_DEFAULT');

        safeText('.txt-map-title', 'MAP_TITLE');
        safeText('.txt-map-grass', 'MAP_GRASS');
        safeText('.txt-map-lava', 'MAP_LAVA');
        safeText('.txt-map-snow', 'MAP_SNOW');

        qa('.txt-sword').forEach(el => el.innerText = t('SWORD'));
        qa('.txt-axe').forEach(el => el.innerText = t('AXE'));
        qa('.txt-spear').forEach(el => el.innerText = t('SPEAR'));
        qa('.txt-strong-vs').forEach(el => el.innerText = t('STRONG_VS'));

        // Instructions Tabs & Content
        safeText('#tab-basic', 'TAB_BASIC');
        safeText('#tab-solo', 'TAB_SOLO');
        safeText('#tab-multi', 'TAB_MULTI');
        safeText('.txt-basic-goal', 'BASIC_GOAL');
        safeText('.txt-basic-ctrl', 'BASIC_CTRL');
        safeText('.txt-basic-energy', 'BASIC_ENERGY');
        safeText('.txt-solo-camp', 'SOLO_CAMP');
        safeText('.txt-solo-save', 'SOLO_SAVE');
        safeText('.txt-solo-upg', 'SOLO_UPG');
        safeText('.txt-solo-star', 'SOLO_STAR');
        safeText('.txt-solo-loss', 'SOLO_LOSS');
        safeText('.txt-multi-local', 'MULTI_LOCAL');
        safeText('.txt-multi-split', 'MULTI_SPLIT');
        safeText('.txt-multi-draft', 'MULTI_DRAFT');
        safeText('.txt-multi-fair', 'MULTI_FAIR');

        const goSub = document.getElementById('game-over-subtext');
        if(goSub) {
            if (goSub.dataset.action === 'next') goSub.innerText = t('NEXT_STAGE_TAP');
            else if (goSub.dataset.action === 'menu') goSub.innerText = t('EXIT_TAP');
        }
        
        const diffLabel = document.getElementById('diff-label');
        if(diffLabel && gameMode === 'CAMPAIGN') diffLabel.innerText = `${t('STAGE')} ${currentLevel}`;
    }
    
    window.switchInstTab = function(tab) {
        document.querySelectorAll('.inst-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.inst-content').forEach(el => el.classList.remove('active'));
        
        if (tab === 'BASIC') {
            document.getElementById('tab-basic').classList.add('active');
            document.getElementById('inst-content-basic').classList.add('active');
        } else if (tab === 'SOLO') {
            document.getElementById('tab-solo').classList.add('active');
            document.getElementById('inst-content-solo').classList.add('active');
        } else if (tab === 'MULTI') {
            document.getElementById('tab-multi').classList.add('active');
            document.getElementById('inst-content-multi').classList.add('active');
        }
        SoundManager.playButton();
    };

    // --- LOGIC ---
    let p1 = { energy: 100, baseHealth: 1000, selectedUnit: UNIT_TYPES.SWORD, stats: {}, upgradeCounts: {}, battleStats: { spawned: 0, damage: 0, kills: 0, perks: 0 }, unitCounts: {SWORD:0, SPEAR:0, AXE:0}, isPlayer1: true };
    let p2 = { energy: 100, baseHealth: 1000, selectedUnit: UNIT_TYPES.SWORD, spawnTimer: 0, waveDifficulty: 1, stats: {}, upgradeCounts: {}, battleStats: { spawned: 0, damage: 0, kills: 0, perks: 0 }, unitCounts: {SWORD:0, SPEAR:0, AXE:0}, isPlayer1: false };
    let units = [], particles = [], floatTexts = [], mapObjects = [], roadDetails = [], envParticles = [];
    let w, h, laneY; 
    let upgradeTimer = 0; 
    let upgradeCurrentPlayer = 1;
    let battleTime = 0;

    // AUDIO - Advanced Music
    const N = { 
        c3: 130.81, d3: 146.83, e3: 164.81, f3: 174.61, g3: 196.00, a3: 220.00, b3: 246.94,
        c4: 261.63, d4: 293.66, e4: 329.63, f4: 349.23, g4: 392.00, a4: 440.00, b4: 493.88,
        c5: 523.25, d5: 587.33, e5: 659.25, f5: 698.46, g5: 783.99, a5: 880.00, _: 0
    };
    
    // Tracks Data
    const TRACKS = {
        MENU: {
            tempo: 120,
            melody: [N.c4, N.e4, N.g4, N.c5, N.e5, N.g4, N.e4, N._, N.c4, N.e4, N.g4, N.c5, N.b4, N.g4, N.d4, N._],
            bass:   [N.c3, N._,  N.c3, N._,  N.g3, N._,  N.c3, N._, N.c3, N._,  N.c3, N._,  N.g3, N._,  N.g3, N._]
        },
        GRASS: {
            tempo: 120, // Marching
            melody: [N.c4, N.c4, N.e4, N.g4, N.c5, N._, N.g4, N.e4, N.f4, N.f4, N.a4, N.c5, N.d5, N._, N.b4, N.g4],
            bass:   [N.c3, N.g3, N.c3, N.g3, N.c3, N.g3, N.c3, N.g3, N.f3, N.c3, N.f3, N.c3, N.g3, N.d3, N.g3, N.d3]
        },
        LAVA: {
            tempo: 160, // Fast & Intense
            melody: [N.c3, N.c3, N.dis3, N.c3, N.f3, N.c3, N.dis3, N.d3, N.c3, N.c3, N.dis3, N.f3, N.g3, N.f3, N.dis3, N.d3],
            bass:   [N.c3, N.c3, N.c3, N.c3, N.c3, N.c3, N.c3, N.c3, N.g3, N.g3, N.g3, N.g3, N.c3, N.c3, N.c3, N.c3]
        },
        SNOW: {
            tempo: 140, // Mysterious
            melody: [N.e5, N._, N.b4, N._, N.g4, N._, N.e4, N._, N.a4, N.f4, N.d4, N._, N.b4, N.g4, N.e4, N._],
            bass:   [N.e3, N._, N.e3, N._, N.b3, N._, N.e3, N._, N.d3, N._, N.d3, N._, N.e3, N._, N.e3, N._]
        }
    };

    const SoundManager = {
        ctx: null, isMuted: false, currentTrack: null, noteIndex: 0, nextNoteTime: 0, schedulerTimer: null,
        init: function() { try { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); } catch(e) {} },
        
        playTone: function(freq, type, duration, vol=0.1) {
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        playNoise: function(duration, vol) {
            if (this.isMuted || !this.ctx) return;
            const bufferSize = this.ctx.sampleRate * duration;
            const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
            const gain = this.ctx.createGain();
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            noise.connect(gain); gain.connect(this.ctx.destination); noise.start();
        },
        
        playBGM: function(key) {
            if (!this.ctx) this.init();
            if (this.isMuted || this.currentTrack === key) return;
            this.stopBGM();
            this.currentTrack = key;
            this.noteIndex = 0;
            this.nextNoteTime = this.ctx.currentTime + 0.1;
            this.schedule();
        },
        stopBGM: function() {
            if (this.schedulerTimer) clearTimeout(this.schedulerTimer);
            this.currentTrack = null;
        },
        schedule: function() {
            if (!this.currentTrack) return;
            const track = TRACKS[this.currentTrack];
            const secondsPerNote = 60.0 / track.tempo / 4; // 16th notes
            
            while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                this.playNote(track, this.nextNoteTime);
                this.nextNoteTime += secondsPerNote;
                this.noteIndex = (this.noteIndex + 1) % 16; // Loop 16 steps
            }
            this.schedulerTimer = setTimeout(() => this.schedule(), 25);
        },
        playNote: function(track, time) {
            if (this.isMuted) return;
            // Melody (Square/Saw)
            const note = track.melody[this.noteIndex];
            if (note && note > 0) {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = this.currentTrack === 'LAVA' ? 'sawtooth' : 'square';
                osc.frequency.value = note;
                gain.gain.setValueAtTime(0.05, time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(time); osc.stop(time + 0.1);
            }
            // Bass (Triangle/Saw)
            const bass = track.bass[this.noteIndex];
            if (bass && bass > 0) {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = bass;
                gain.gain.setValueAtTime(0.1, time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(time); osc.stop(time + 0.2);
            }
            // Drums (Noise)
            if (this.noteIndex % 4 === 0) { // Kick on beat
                this.playNoiseAtTime(0.05, 0.15, time); // Kick
            } else if (this.noteIndex % 8 === 4) { // Snare
                this.playNoiseAtTime(0.05, 0.1, time);
            }
        },
        playNoiseAtTime: function(duration, vol, time) {
             const b = this.ctx.createBuffer(1, this.ctx.sampleRate*duration, this.ctx.sampleRate);
             const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
             const n=this.ctx.createBufferSource(); n.buffer=b; const g=this.ctx.createGain();
             g.gain.setValueAtTime(vol, time); g.gain.exponentialRampToValueAtTime(0.001, time+duration);
             n.connect(g); g.connect(this.ctx.destination); n.start(time);
        },

        // SFX
        playButton: function() { this.playTone(400,'triangle',0.05,0.1); },
        playSpawn: function() { this.playTone(600,'square',0.1,0.1); },
        playHit: function() { this.playNoise(0.05, 0.1); },
        playAttack: function() { this.playNoise(0.1, 0.1); },
        playLevelUp: function() { 
            const t = this.ctx.currentTime;
            [440, 554, 659, 880].forEach((f,i) => {
                const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                o.type='square'; o.frequency.value=f;
                g.gain.setValueAtTime(0.1, t+i*0.1); g.gain.exponentialRampToValueAtTime(0.001, t+i*0.1+0.2);
                o.connect(g); g.connect(this.ctx.destination); o.start(t+i*0.1); o.stop(t+i*0.1+0.2);
            });
        }
    };
    window.toggleMute = function() { SoundManager.isMuted = !SoundManager.isMuted; document.getElementById('mute-btn').innerText = SoundManager.isMuted ? "SOUND: OFF" : "SOUND: ON"; SoundManager.init(); if(SoundManager.isMuted) SoundManager.stopBGM(); else SoundManager.playBGM(currentState===GAME_STATE.PLAYING ? currentMapKey : 'MENU'); };

    const MAPS = {
        GRASS: { bg: "#1a241a", road: "#463628", roadDetail: "#3a2a1f", roadDecor: ["#3e3228", "#554433"], decorTypes: ['TREE','ROCK','GRASS'], decorColor: {tree:"#1b5e20",rock:"#444",grass:"#2d402d"}, particle: null, vignette: "rgba(0,0,0,0.6)" },
        LAVA: { bg: "#2a0a0a", road: "#3d1010", roadDetail: "#501515", roadDecor: ["#602020", "#220505"], decorTypes: ['DEAD_TREE','ROCK','CRACK'], decorColor: {tree:"#221111",rock:"#3d2020",grass:"#551111"}, particle: "EMBER", vignette: "rgba(50,10,0,0.5)" },
        SNOW: { bg: "#d0dce8", road: "#aabccd", roadDetail: "#8a9cb0", roadDecor: ["#99aabb", "#ddeeff"], decorTypes: ['SNOW_TREE','ICE_ROCK','SNOW_PILE'], decorColor: {tree:"#2d4a3e",rock:"#aaddff",grass:"#fff"}, particle: "SNOW", vignette: "rgba(0,20,50,0.4)" }
    };
    
    const PERKS = [
        { id: 'SWORD_DMG', names: {'zh-TW':'ÈãíÂà©ÂäçÂàÉ','en':'SHARPENED BLADES','ja':'Èã≠Âà©„Å™ÂàÉ'}, descs: {'zh-TW':'ÂäçÂÖµÂÇ∑ÂÆ≥ +20%','en':'Sword units +20% Damage','ja':'Ââ£ÂÖµ„ÅÆ„ÉÄ„É°„Éº„Ç∏+20%'}, type: 'BUFF', icon: '‚öîÔ∏è', unitType: 'SWORD', apply: (p) => p.stats.swordDmg += 0.2 },
        { id: 'SPEAR_HP', names: {'zh-TW':'ÊñπÈô£ÁõæÁâå','en':'PHALANX SHIELD','ja':'„Éï„Ç°„É©„É≥„ÇØ„Çπ'}, descs: {'zh-TW':'ÊßçÂÖµÁîüÂëΩ +20%','en':'Spear units +20% HP','ja':'ÊßçÂÖµ„ÅÆHP+20%'}, type: 'BUFF', icon: 'üõ°Ô∏è', unitType: 'SPEAR', apply: (p) => p.stats.spearHp += 0.2 },
        { id: 'AXE_SPD', names: {'zh-TW':'ÁãÇÊà∞Â£´‰πãÊÄí','en':'BERSERKER RAGE','ja':'„Éê„Éº„Çµ„Éº„Ç´„Éº'}, descs: {'zh-TW':'ÊñßÂÖµÈÄüÂ∫¶ +15%','en':'Axe units +15% Speed','ja':'ÊñßÂÖµ„ÅÆÈÄüÂ∫¶+15%'}, type: 'BUFF', icon: '‚ö°', unitType: 'AXE', apply: (p) => p.stats.axeSpd += 0.15 },
        { id: 'ENERGY_BST', names: {'zh-TW':'ÂæåÂã§Ë£úÁµ¶','en':'LOGISTICS','ja':'ÂÖµÁ´ôÁ¢∫‰øù'}, descs: {'zh-TW':'ËÉΩÈáèÂõûÂæ© +15%','en':'Energy Regen +15%','ja':'„Ç®„Éç„É´„ÇÆ„ÉºÂõûÂæ©+15%'}, type: 'ECO', icon: 'üîã', unitType: null, apply: (p) => p.stats.energyRate += 0.15 },
        { id: 'BASE_REP', names: {'zh-TW':'Â†°Â£ò‰øÆÂæ©','en':'FORTIFY','ja':'Ë¶ÅÂ°û‰øÆÂæ©'}, descs: {'zh-TW':'Âü∫Âú∞ÂõûÂæ© 300 HP','en':'Repair Base +300 HP','ja':'Âü∫Âú∞HP+300ÂõûÂæ©'}, type: 'ECO', icon: 'üè∞', unitType: null, apply: (p) => p.baseHealth = Math.min(1000, p.baseHealth + 300) },
        { id: 'ALL_HP', names: {'zh-TW':'Êà∞ÊôÇÈÖçÁµ¶','en':'RATIONS','ja':'ÈáéÊà¶Á≥ßÈ£ü'}, descs: {'zh-TW':'ÂÖ®ÂñÆ‰ΩçÁîüÂëΩ +10%','en':'All units +10% HP','ja':'ÂÖ®„É¶„Éã„ÉÉ„ÉàHP+10%'}, type: 'BUFF', icon: 'üçé', unitType: 'ALL', apply: (p) => { p.stats.swordHp+=0.1; p.stats.spearHp+=0.1; p.stats.axeHp+=0.1; } }
    ];
 
    function initStats(p) {
        p.stats = { swordDmg: 1.0, swordHp: 1.0, swordSpd: 1.0, spearDmg: 1.0, spearHp: 1.0, spearSpd: 1.0, axeDmg: 1.0, axeHp: 1.0, axeSpd: 1.0, energyRate: 1.0 };
        p.upgradeCounts = { SWORD: 0, SPEAR: 0, AXE: 0 };
        p.battleStats = { spawned: 0, damage: 0, kills: 0, perks: 0 };
        p.unitCounts = { SWORD: 0, SPEAR: 0, AXE: 0 };
    }

    function resize() {
        // 1. ÂÖà‰øùÂ≠òËàäÁöÑÂØ¨Â∫¶ (Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°Âü∑Ë°åÔºåw ÂèØËÉΩÊòØ undefinedÔºåË®≠ÁÇ∫ 0)
        const oldW = w || 0;

        scaleRatio = window.devicePixelRatio || 1;
        w = window.innerWidth; h = window.innerHeight;
        canvas.width = w * scaleRatio; canvas.height = h * scaleRatio;
        ctx.resetTransform(); ctx.scale(scaleRatio, scaleRatio);
        renderScale = Math.max(1, h / 320);
        
        // ÈáçÊñ∞Ë®àÁÆóËªåÈÅì Y Ëª∏‰ΩçÁΩÆ
        const topPadding = Math.max(h * 0.15, 40); const bottomPadding = Math.max(h * 0.20, 80); const playAreaHeight = h - topPadding - bottomPadding;
        laneY = [ topPadding + playAreaHeight/6, topPadding + playAreaHeight/2, topPadding + playAreaHeight*5/6 ];

        // ‚úÖ [BUG ‰øÆÂæ©] Â¶ÇÊûúÈÅäÊà≤Ê≠£Âú®ÈÄ≤Ë°å‰∏≠Ôºå‰∏îË¶ñÁ™óÂ§ßÂ∞èÁ¢∫ÂØ¶ÊîπËÆä‰∫ÜÔºåÂ∞±‰æùÊØî‰æãË™øÊï¥ÊâÄÊúâÁâ©‰ª∂ÁöÑ X Â∫ßÊ®ô
        if (oldW > 0 && currentState === GAME_STATE.PLAYING) {
            const ratio = w / oldW;
            
            // ‰øÆÊ≠£ÂñÆ‰Ωç‰ΩçÁΩÆ
            units.forEach(u => { 
                u.x *= ratio; 
                u.y = laneY[u.lane] + u.yOffset;
                });
            
            // ‰øÆÊ≠£Á≤íÂ≠êÊïàÊûú‰ΩçÁΩÆ
            particles.forEach(p => { p.x *= ratio; });
            envParticles.forEach(p => { p.x *= ratio; });
            floatTexts.forEach(f => { f.x *= ratio; });
        }

        if (currentState === GAME_STATE.PLAYING) generateMapDetails();
        else initMenuEntities();
    }
    window.addEventListener('resize', resize);
    
    function generateMapDetails() {
        mapObjects = []; roadDetails = [];
        const map = MAPS[currentMapKey];
        for(let l=0; l<3; l++) {
             const ly = laneY[l];
             for(let i=0; i<Math.floor(w/30); i++) roadDetails.push({ x: Math.random()*w, y: ly-30+Math.random()*60, color: map.roadDecor[0], type: 'PEBBLE' });
        }
        const zones = [{minY:0,maxY:laneY[0]-50}, {minY:laneY[0]+50,maxY:laneY[1]-50}, {minY:laneY[1]+50,maxY:laneY[2]-50}, {minY:laneY[2]+50,maxY:h}];
        zones.forEach(z => {
            const ah = z.maxY-z.minY; if(ah<10)return;
            for(let i=0; i<Math.ceil(w/80); i++) {
                if(Math.random()>0.7) mapObjects.push({x:Math.random()*w, y:z.minY+Math.random()*ah, type:map.decorTypes[Math.floor(Math.random()*2)], z:Math.random()>0.5?10:0});
            }
        });
        mapObjects.sort((a,b)=>a.y-b.y);
    }
    
    // --- UI HELPER: HIDE ALL MENUS ---
    function hideAllMenus() {
        // Ë´ãÁ¢∫‰øù 'treasury-menu' Ë¢´Âä†ÈÄ≤Âéª
        ['main-menu', 'campaign-menu', 'slot-lobby-menu', 'map-select-menu', 'game-over-screen', 
         'instructions-screen', 'upgrade-menu', 'skill-tree-menu', 'p1-ui', 'p2-ui', 'top-hud', 'custom-modal', 
         'dice-modal', 'treasury-menu'] // <--- ÈÄôË£°Âä†ÂÖ•‰∫Ü treasury-menu Âíå dice-modal
        .forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });
    }

    // --- UI NAVIGATION ---
    window.showMainMenu = function() { 
        SoundManager.playBGM('MENU'); 
        hideAllMenus();
        currentState = GAME_STATE.MENU; 
        document.getElementById('main-menu').style.display = 'flex'; 
    };

    window.showCampaignMenu = function() {
        SoundManager.playButton(); 
        hideAllMenus();
        currentState = GAME_STATE.CAMPAIGN_MENU;
        document.getElementById('campaign-menu').style.display = 'flex';
        renderSaveSlots();
    };

    window.showSlotLobby = function() {
        SoundManager.playButton(); 
        hideAllMenus();
        currentState = GAME_STATE.SLOT_LOBBY;
        document.getElementById('slot-lobby-menu').style.display = 'flex';
        
        // Update Lobby Info
        const meta = currentSlotData ? currentSlotData.meta : {stars:0};
        const run = currentSlotData ? currentSlotData.run : null;
        let info = `‚≠ê ${meta.stars}`;
        if(run) info += `<br>${t('STAGE')} ${run.level}`;
        else info += `<br>${t('NEW_GAME')}`;
        document.getElementById('lobby-info').innerHTML = info;

        
    }
    
    window.showSkillTree = function() {
        SoundManager.playButton(); 
        hideAllMenus();
        currentState = GAME_STATE.SKILL_TREE;
        document.getElementById('skill-tree-menu').style.display = 'flex';
        renderSkillTree();

        //Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®ÈÄ≤Ë°åÈÅäÊà≤
        const isMidRun = currentSlotData && currentSlotData.run;
        const skillBtn = document.querySelector('#slot-lobby-menu .btn-skill-tree');
    
        if (isMidRun) {
            skillBtn.style.opacity = '0.5';
            skillBtn.style.pointerEvents = 'none';
            skillBtn.innerText = "LOCKED (IN RUN)";
        } else {
            skillBtn.style.opacity = '1';
            skillBtn.style.pointerEvents = 'auto';
            skillBtn.innerText = "SKILL TREE";
        }

    };
    
    window.renderSkillTree = function() {
        const container = document.getElementById('skill-tree-container');
        // Ê∏ÖÈô§ËàäÁØÄÈªû
        const nodes = container.querySelectorAll('.skill-node'); nodes.forEach(n => n.remove());
        
        // ÂÆâÂÖ®Ê™¢Êü•ÔºöÁ¢∫‰øù skills ÊòØÁâ©‰ª∂ (Áõ∏ÂÆπËàäÂ≠òÊ™î)
        let currentMeta = currentSlotData ? currentSlotData.meta : {stars:0, skills:{}};
        if (Array.isArray(currentMeta.skills)) {
            // Á∞°ÂñÆÈÅ∑ÁßªÔºöÂ¶ÇÊûúÊòØËàäÈô£ÂàóÔºåËΩâÁÇ∫Áâ©‰ª∂ÔºåÊØèÂÄãÁ≠âÁ¥öË®≠ÁÇ∫ 1
            const arr = currentMeta.skills; 
            currentMeta.skills = {};
            arr.forEach(id => currentMeta.skills[id] = 1);
        }
        if (!currentMeta.skills) currentMeta.skills = {};

        document.getElementById('stars-display').innerText = `‚≠ê: ${currentMeta.stars}`;
        const svg = document.getElementById('skill-svg'); svg.innerHTML = '';

        SKILL_TREE.forEach(skill => {
            const level = currentMeta.skills[skill.id] || 0;
            // Âà§Êñ∑Áà∂ÁØÄÈªûÊòØÂê¶ÊúâÁ≠âÁ¥ö (level > 0 Âç≥Ë¶ñÁÇ∫Â∑≤Ëß£Èéñ)
            const parentUnlocked = !skill.parent || (currentMeta.skills[skill.parent] && currentMeta.skills[skill.parent] > 0);
            
            // Âè™Ë¶ÅÁà∂ÁØÄÈªûËß£Èéñ‰∫ÜÔºåÂ∞±ÂèØ‰ª•ÁÑ°ÈôêË≤∑Ôºå‰∏çÂÜçÊúâ "unlocked" Á¶ÅÊ≠¢Ë≥ºË≤∑ÁöÑÁãÄÊÖã
            const affordable = currentMeta.stars >= skill.cost;
            const available = parentUnlocked; // Âè™Ë¶ÅÁà∂ÁØÄÈªûÊúâÂ≠∏ÔºåÈÄôÂÄãÁØÄÈªûÂ∞±ÂèØË¶ã/ÂèØË≤∑

            // Áπ™Ë£ΩÈÄ£Á∑ö
            if (skill.parent) {
                const parent = SKILL_TREE.find(s => s.id === skill.parent);
                if (parent) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parent.x + '%'); line.setAttribute('y1', parent.y + '%');
                    line.setAttribute('x2', skill.x + '%'); line.setAttribute('y2', skill.y + '%');
                    // Á∑öÊ¢ùÈ°èËâ≤ÔºöÂ¶ÇÊûúÁï∂ÂâçÁØÄÈªûÊúâÈªûÈÅé (level>0)ÔºåÁ∑öÊ¢ù‰∫ÆËµ∑
                    line.setAttribute('class', `skill-path ${level > 0 ? 'active' : ''}`); 
                    svg.appendChild(line);
                }
            }

            // Áπ™Ë£ΩÁØÄÈªû
            const node = document.createElement('div');
            // Ê®£ÂºèÈÇèËºØÔºölevel > 0 Â∞±Áî® unlocked Ê®£ÂºèÔºå‰ΩÜÂ¶ÇÊûúÈÇÑËÉΩË≤∑‰∏îÈå¢Â§†ÔºåÊúÉÁñäÂä† available ÂãïÁï´
            let nodeClass = 'skill-node';
            if (level > 0) nodeClass += ' unlocked';
            if (available && affordable) nodeClass += ' available'; // ÈñÉÁàçÊïàÊûú
            if (!available) nodeClass += ' locked';

            node.className = nodeClass;
            node.style.left = skill.x + '%'; node.style.top = skill.y + '%';
            
            // È°ØÁ§∫ÂÖßÂÆπÔºöÂ¢ûÂä†Á≠âÁ¥öÈ°ØÁ§∫
            const costText = `${skill.cost}‚≠ê`;
            const levelText = level > 0 ? `<span style="color:#0f0; font-size:1vh">Lv.${level}</span>` : '';
            
            node.innerHTML = `
                <div class="skill-icon">${skill.icon}</div>
                <div class="skill-cost" style="font-size:1vh">${levelText} ${costText}</div>
                <div class="skill-tooltip">
                    <div style="color:#ffd700">${skill.name[currentLang]} (Lv.${level})</div>
                    <div>${skill.desc[currentLang]}</div>
                    <div style="color:#aaa; font-size:1vh; margin-top:0.5vh">Next Lv Cost: ${skill.cost}‚≠ê</div>
                </div>`;

            node.onclick = () => { 
                if(available && affordable && currentSlotData) { 
                    currentSlotData.meta.stars -= skill.cost; 
                    // ÂçáÁ¥öÈÇèËºØÔºöÁ≠âÁ¥ö + 1
                    currentSlotData.meta.skills[skill.id] = (currentSlotData.meta.skills[skill.id] || 0) + 1;
                    
                    saveCurrentSlot(); 
                    SoundManager.playLevelUp(); 
                    renderSkillTree(); 
                } 
            };
            container.appendChild(node);
        });
    };
    
    window.initMultiplayer = function() { SoundManager.playButton(); gameMode = 'MULTI'; window.goToMapSelect('MULTI'); };
    window.goToMapSelect = function(mode) { 
        SoundManager.playButton(); 
        hideAllMenus();
        gameMode = mode; 
        document.getElementById('map-select-menu').style.display = 'flex'; 
        currentState = GAME_STATE.MAP_SELECT; 
    };
    window.showInstructions = function() { 
        SoundManager.playButton(); 
        hideAllMenus();
        document.getElementById('instructions-screen').style.display = 'flex'; 
        currentState = GAME_STATE.INSTRUCTIONS; 
    };
    window.selectUnit = function(pNum, type) { SoundManager.playButton(); const p = pNum===1?p1:p2; p.selectedUnit = UNIT_TYPES[type]; document.querySelectorAll(`#p${pNum}-ui .unit-btn`).forEach(b=>b.classList.remove(`selected-p${pNum}`)); document.getElementById(`${pNum===1?'btn-p1-':'btn-p2-'}${type.toLowerCase()}`).classList.add(`selected-p${pNum}`); };
    
    window.initGame = function(mapKey) {
        SoundManager.playButton(); 
        currentMapKey = mapKey; 
        SoundManager.playBGM(mapKey);
        hideAllMenus();
        document.getElementById('p1-ui').style.display = 'flex';
        document.getElementById('p2-ui').style.display = gameMode==='MULTI'?'flex':'none';
        initStats(p1); if(gameMode==='MULTI') initStats(p2); startGame(false);
    };

    window.initCampaign = function() { 
        SoundManager.playButton(); 
        gameMode = 'CAMPAIGN'; 
        currentLevel = 1; 
        currentLoop = 0; // Êñ∞ÈÅäÊà≤ Loop ÁÇ∫ 0
        initStats(p1); 
        startGame(false); 
    };

    window.launchLevel = function() {
        SoundManager.playButton();
        if(currentSlotData && currentSlotData.run) {
            gameMode = 'CAMPAIGN'; 
            currentLevel = currentSlotData.run.level; 
            currentLoop = currentSlotData.run.loop || 0; // ËÆÄÂèñ LoopÔºåÊ≤íÊúâÂâáÁÇ∫ 0
            
            // ËÆÄÂèñÁé©ÂÆ∂ÁãÄÊÖã
            p1.stats = JSON.parse(JSON.stringify(currentSlotData.run.p1Stats)); 
            p1.upgradeCounts = JSON.parse(JSON.stringify(currentSlotData.run.p1Upgrades)); 
            p1.battleStats = currentSlotData.run.p1BattleStats || { spawned: 0, damage: 0, kills: 0, perks: 0 };
            
            startGame(true); //Resume
        } else {
            initCampaign(); //New start
        }
    }

    function startGame(isNextLevel) {
        currentState = GAME_STATE.PLAYING;
        hideAllMenus();
        
        // --- Èõ£Â∫¶Ë®àÁÆóÊ†∏ÂøÉÂÖ¨Âºè ---
        // Á∏ΩÈóúÂç°Êï∏Ê¨äÈáç = (Ëº™Ëø¥Êï∏ * 10) + Áï∂ÂâçÈóúÂç°
        const difficultyFactor = 1 + (currentLoop * 0.5) + ((currentLevel - 1) * 0.05);
        
        if (isNextLevel) {
            // Âª∂Á∫åÁãÄÊÖã
            p1.energy = 50; p1.baseHealth = 1000; 
            p2.energy = 50; 
            // AI Âü∫Âú∞Ë°ÄÈáèÈö®Ëº™Ëø¥Â§ßÂπÖÊèêÂçá (ÊØèËº™Ëø¥ +2000)
            p2.baseHealth = 1000 + (currentLoop * 2000) + (currentLevel * 100); 
            
            p2.spawnTimer = 0;
            
            // --- AI Â¢ûÂº∑ÈÇèËºØ ---
            // 1. Ê≥¢ÂãïÈõ£Â∫¶ÔºöÊØèËº™Ëø¥ AI ËÆäÂæóÊõ¥ËÅ∞Êòé/Êõ¥Âº∑
            p2.waveDifficulty = difficultyFactor; 
            
            // 2. Á∂ìÊøü‰ΩúÂºäÔºöAI ÂõûËÉΩÈÄüÂ∫¶Èö®Ëº™Ëø¥ÊèêÂçá (ÊØèËº™Ëø¥ +20%)
            p2.stats.energyRate = 1.0 + (currentLoop * 0.2); 

            // 3. ÂàùÂßãÁßëÊäÄÔºöÈ´òËº™Ëø¥ÊôÇÔºåAI Ëµ∑ÊâãÂ∞±ÊòØÈ´òÁ¥öÂÖµ (Tier)
            // Loop 0 = Tier 0, Loop 1 = Tier 1... Max Tier 10
            const startTier = Math.min(10, currentLoop);
            p2.upgradeCounts = { SWORD: startTier, SPEAR: startTier, AXE: startTier };

            // Map Cycle
            const mapKeys = ['GRASS', 'LAVA', 'SNOW'];
            currentMapKey = mapKeys[(currentLevel - 1) % mapKeys.length];
            SoundManager.playBGM(currentMapKey);
        } else {
            // New Game
            p1.energy = 50; p1.baseHealth = 1000; initStats(p1); 
            p2.energy = 50; p2.baseHealth = 1000; initStats(p2);
            p2.spawnTimer = 0; p2.waveDifficulty = 1; 
            currentLevel = 1; currentLoop = 0; // Reset Loop
            if(gameMode==='CAMPAIGN') currentMapKey = 'GRASS';
            
            // ‚úÖ [Êï∏ÂÄºÂàùÂßãÂåñÂæåÔºåÂ•óÁî®ÊäÄËÉΩÂä†Êàê]
            // ÁÑ°ÈôêÁ≠âÁ¥öÈÇèËºØÔºöËÆÄÂèñÁ≠âÁ¥ö‰∏¶ÂÇ≥ÂÖ• effect
            if(gameMode==='CAMPAIGN' && currentSlotData && currentSlotData.meta.skills) {
                 const userSkills = currentSlotData.meta.skills;
                 // Áõ∏ÂÆπÊÄßÊ™¢Êü•ÔºöÂ¶ÇÊûúÊòØËàäÈô£ÂàóÔºåÂÖà‰∏çÂ¥©ÊΩ∞ (ÈõñÁÑ∂ renderSkillTree ÊúÉ‰øÆÂæ©ÂÆÉ)
                 if (!Array.isArray(userSkills)) {
                     SKILL_TREE.forEach(s => { 
                         const lvl = userSkills[s.id] || 0;
                         if (lvl > 0) s.effect(p1, lvl); 
                     });
                 }
            }
        }
        units = []; particles = []; floatTexts = []; envParticles = [];
        upgradeTimer = UPGRADE_INTERVAL;
        battleTime = 0;

        // Êõ¥Êñ∞ UI È°ØÁ§∫ Loop
        const hudText = gameMode==='CAMPAIGN' ? `LOOP ${currentLoop} - ${t('STAGE')} ${currentLevel}` : '';
        
        document.getElementById('top-hud').style.display = 'block';
        document.getElementById('diff-label').innerText = hudText;
        document.getElementById('p1-ui').style.display = 'flex';
        document.getElementById('p2-ui').style.display = gameMode==='MULTI'?'flex':'none';
        resize(); generateMapDetails();
    }

    // --- GAME LOOP & LOGIC ---
    function update(dt) {
        if (currentState !== GAME_STATE.PLAYING) {
            if(currentState === GAME_STATE.MENU || currentState === GAME_STATE.CAMPAIGN_MENU || currentState === GAME_STATE.SLOT_LOBBY) {
                menuScroll += dt * 100;
                menuEntities.forEach(e => {
                    if(e.type==='RUNNER') { e.x+=e.speed*dt; e.animFrame+=dt*15; if(e.x>w+50)e.x=-50; }
                    else if(e.type==='DUST') { e.x+=e.vx*dt; e.y+=e.vy*dt; e.life-=dt; }
                });
                menuEntities = menuEntities.filter(e => e.life===undefined || e.life > 0);
            }
            return;
        }

        //Ë®àÊôÇÈÇèËºØ
        battleTime += dt;
        const minutes = Math.floor(battleTime / 60);
        const seconds = Math.floor(battleTime % 60);
        // Ê†ºÂºèÂåñÁÇ∫ MM:SS (‰æãÂ¶Ç 01:05)
        document.getElementById('game-time').innerText = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;


        upgradeTimer -= dt; document.getElementById('council-timer').innerText = `NEXT: ${Math.ceil(upgradeTimer)}s`;
        if (upgradeTimer <= 0) { currentState = GAME_STATE.UPGRADE; startDraft(1); }
        if (p1.energy < 200) p1.energy += 25 * p1.stats.energyRate * dt;
        if (p2.energy < 200) p2.energy += 25 * p2.stats.energyRate * dt;

        // --- ü§ñ Âº∑ÂåñÁâà AI ÈÇèËºØ (ÂåÖÂê´ Bug ‰øÆÂæ©Ëàá Loop Â¢ûÂº∑) ---
        if (gameMode === 'CAMPAIGN') {
            p2.spawnTimer -= dt;
            
            // È´òËº™Ëø¥ÊôÇÔºåÂá∫ÂÖµÂÜ∑ÂçªÊôÇÈñìÁ∏ÆÁü≠
            // Âü∫Á§é 2.0ÁßíÔºåÊØèÂ¢ûÂä† 1Èõ£Â∫¶Á≥ªÊï∏ Ê∏õÂ∞ë 0.1ÁßíÔºåÊúÄ‰Ωé 0.5Áßí
            const minSpawnTime = Math.max(0.5, 2.0 - (p2.waveDifficulty * 0.1));
            
            if (p2.spawnTimer <= 0) {
                // 1. Êà∞Â†¥ÊéÉÊèè
                let laneThreats = [0, 0, 0];
                let laneFrontUnitType = [null, null, null]; 

                units.forEach(u => {
                    if (u.isPlayer1) { 
                        const distFactor = u.x / w; 
                        laneThreats[u.lane] += (1 + distFactor * 3); 
                        if (laneFrontUnitType[u.lane] === null || u.x > laneFrontUnitType[u.lane].x) {
                            laneFrontUnitType[u.lane] = { x: u.x, type: u.type.name };
                        }
                    }
                });

                // 2. Ê±∫Á≠ñ
                let targetLane = -1;
                let maxThreat = 0;
                for(let i=0; i<3; i++) {
                    if (laneThreats[i] > maxThreat) {
                        maxThreat = laneThreats[i];
                        targetLane = i;
                    }
                }

                let spawnType = null;
                let spawnLane = 0;

                // 3. Ë°åÂãï (Âä†ÂÖ• Bug FixÔºöÊ™¢Êü• laneFrontUnitType[targetLane] ÊòØÂê¶Â≠òÂú®)
                if (maxThreat > 2.0 && laneFrontUnitType[targetLane]) { 
                    spawnLane = targetLane;
                    const enemyType = laneFrontUnitType[targetLane].type;
                    
                    if (enemyType === 'SWORD') spawnType = UNIT_TYPES.SPEAR;
                    else if (enemyType === 'SPEAR') spawnType = UNIT_TYPES.AXE;
                    else if (enemyType === 'AXE') spawnType = UNIT_TYPES.SWORD;
                    
                } else {
                    spawnLane = Math.floor(Math.random() * 3);
                    const r = Math.random();
                    const k = r < 0.33 ? 'SWORD' : (r < 0.66 ? 'AXE' : 'SPEAR');
                    spawnType = UNIT_TYPES[k];
                }

                // 4. Âü∑Ë°åÂá∫ÂÖµ & Ê™¢Êü•ËÉΩÈáè
                // AI Âú®È´òËº™Ëø¥ÊôÇÊúÉË©¶Âúñ„ÄåÈÄ£Êìä„Äç(Double Spawn)
                // Â¶ÇÊûú AI ËÉΩÈáèÂ§†Â§ö (>40)Ôºå‰∏îËôïÊñº Loop 1 ‰ª•‰∏äÔºåÊúâÊ©üÊúÉ‰∏ÄÊ¨°Âá∫ÂÖ©Èöª
                if (p2.energy >= 20) {
                     p2.energy -= 20;
                     units.push(new Unit(spawnLane, spawnType, false));
                     SoundManager.playSpawn();

                     // Loop Âä†ÊàêÔºöÈÄ£ÊìäÊ©üÁéá
                     if (currentLoop > 0 && p2.energy >= 20 && Math.random() < (currentLoop * 0.1)) {
                         setTimeout(() => {
                             if(p2.energy >= 20) {
                                p2.energy -= 20;
                                p2.battleStats.spawned++; 
                                p2.unitCounts[spawnType.name]++;
                                
                                units.push(new Unit(spawnLane, spawnType, false)); // ÂÜçÂá∫‰∏ÄÈöª
                             }
                         }, 200); // Âª∂ÈÅ≤ 0.2ÁßíÂæåËøΩÂä†
                     }
                }

                p2.spawnTimer = minSpawnTime;
            }
        }
        // --- ü§ñ AI ÈÇèËºØÁµêÊùü ---


        units.forEach(u => u.update(dt));
        units = units.filter(u => u.hp > 0);
        floatTexts.forEach(f => { f.y += f.vy*dt; f.life -= dt; }); floatTexts = floatTexts.filter(f => f.life > 0);
        const map = MAPS[currentMapKey]; if (map.particle && Math.random() < 0.2) spawnEnvParticles(map.particle);
        for(let i=particles.length-1; i>=0; i--) { particles[i].x+=particles[i].vx*dt; particles[i].y+=particles[i].vy*dt; particles[i].life-=dt; if(particles[i].life<=0) particles.splice(i,1); }
        for(let i=envParticles.length-1; i>=0; i--) { envParticles[i].x+=envParticles[i].vx*dt; envParticles[i].y+=envParticles[i].vy*dt; envParticles[i].life-=dt; if(envParticles[i].life<=0) envParticles.splice(i,1); }
    }

    class Unit {
        constructor(lane, type, isPlayer1) {
            this.lane = lane; this.type = type; this.isPlayer1 = isPlayer1;
            this.x = isPlayer1 ? 70 : w - 70; 
            this.yOffset = (Math.random() * 30 - 15); // 1. ÂÖàË®ò‰ΩèÂÅèÁßªÈáè
            this.y = laneY[lane] + this.yOffset;      // 2. ÂÜçË®≠ÂÆöÂ∫ßÊ®ô

            const owner = isPlayer1 ? p1 : p2;
            const count = owner.upgradeCounts[type.name] || 0; this.tier = count;
  
            this.tier = count;
            this.level = count + 1;

            let mD=1, mH=1, mS=1; 
            if(type.name==='SWORD'){ mD=owner.stats.swordDmg; mH=owner.stats.swordHp; mS=owner.stats.swordSpd; }
            if(type.name==='SPEAR'){ mD=owner.stats.spearDmg; mH=owner.stats.spearHp; mS=owner.stats.spearSpd; }
            if(type.name==='AXE'){ mD=owner.stats.axeDmg; mH=owner.stats.axeHp; mS=owner.stats.axeSpd; }
            if(count>=3) { mD*=1.2; mH*=1.2; }
            if(!isPlayer1 && gameMode==='CAMPAIGN') { const diff = 1+(currentLevel-1)*0.2; mD*=diff; mH*=diff; } // 0.2 diff scaling
            this.maxHp=50*mH; this.hp=this.maxHp; this.damage=10*mD; this.speed=(isPlayer1?50:-50)*mS;
            this.range=30; this.state='WALK'; this.attackCooldown=0; this.attackSpeed=1.0; this.animFrame=Math.random()*100; this.scale=count>=5?1.1:1.0; this.flashTime=0;
        }
        update(dt) {
            this.animFrame+=dt*10; if(this.flashTime>0) this.flashTime-=dt; if(this.attackCooldown>0) this.attackCooldown-=dt;
            let target=null; let minD=Infinity;
            if(this.isPlayer1 && this.x>w-80) { target="BASE"; minD=0; } else if(!this.isPlayer1 && this.x<80) { target="BASE"; minD=0; }
            else { for(let u of units) { if(u.lane===this.lane && u.isPlayer1!==this.isPlayer1 && u.hp>0) { let d=Math.abs(u.x-this.x); if(d<this.range && d<minD){ minD=d; target=u; } } } }
            if(target) { this.state='ATTACK'; if(this.attackCooldown<=0) this.attack(target); } else { this.state='WALK'; this.x+=this.speed*dt; }
        }
        attack(target) {
            this.attackCooldown=this.attackSpeed; SoundManager.playAttack(); let dmg=this.damage;
            if(target!=="BASE") {
                const m=this.type.id, e=target.type.id;
                if((m===0&&e===2)||(m===2&&e===1)||(m===1&&e===0)) { dmg*=2; createFloatText(target.x,target.y-20,t('CRIT'),"#ff0"); }
                else if(m!==e) { dmg*=0.5; createFloatText(target.x,target.y-20,t('WEAK'),"#888"); }
                target.takeDamage(dmg); if(target.hp<=0 && this.isPlayer1) p1.battleStats.kills++;
            } else {
                SoundManager.playHit();
                if(this.isPlayer1) { p2.baseHealth-=dmg; p1.battleStats.damage+=Math.floor(dmg); createFloatText(w-60,laneY[this.lane],Math.floor(dmg),"#fff"); if(p2.baseHealth<=0) gameOver(true); }
                else { p1.baseHealth-=dmg; p2.battleStats.damage+=Math.floor(dmg); createFloatText(60,laneY[this.lane],Math.floor(dmg),"#f00"); if(p1.baseHealth<=0) gameOver(false); }
            }
        }
        takeDamage(d) { this.hp -= d; this.flashTime=0.1; SoundManager.playHit(); spawnParticles(this.x, this.y, this.type.color, 3); }
        draw(ctx) {
            ctx.save(); ctx.translate(this.x, this.y); ctx.scale(this.isPlayer1 ? 1 : -1, 1);
            const s = this.scale * renderScale; ctx.scale(s, s);
            const isWalking = this.state === 'WALK'; const isAttacking = this.state === 'ATTACK'; const attackProgress = isAttacking ? (1 - this.attackCooldown / this.attackSpeed) : 0;
            const breathY = isWalking ? Math.sin(this.animFrame * 0.8) * 1.5 : Math.sin(this.animFrame * 0.2) * 0.5;
            const legCycle = isWalking ? Math.sin(this.animFrame) * 3 : 0; const isElite = this.tier >= 3;
            ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.beginPath(); ctx.ellipse(0, 6, 6, 2, 0, 0, Math.PI*2); ctx.fill();
            const flash = this.flashTime > 0; const team = this.isPlayer1 ? '#4d9be6' : '#e64d4d'; 
            const c_main = flash ? '#fff' : team; const c_skin = flash ? '#fff' : '#ffccaa'; const c_metal = flash ? '#fff' : (isElite ? '#ffd700' : '#ccc'); 
            const c_dark = flash ? '#fff' : '#555'; const c_wood = flash ? '#fff' : '#8B4513'; const c_leather = flash ? '#fff' : '#6B4226'; const c_elite_trim = isElite ? '#ff0000' : c_dark; 
            ctx.fillStyle = (this.type.name === 'SWORD') ? c_dark : c_leather; ctx.fillRect(-2 - legCycle, 0, 3, 7); ctx.fillRect(2 + legCycle, 0, 3, 7);
            ctx.translate(0, breathY);
            if (this.type.name === 'SWORD') {
                if (isElite) { ctx.fillStyle = c_elite_trim; ctx.beginPath(); ctx.moveTo(-4, -10); ctx.lineTo(-8, 2); ctx.lineTo(0, 2); ctx.fill(); }
                ctx.fillStyle = c_metal; ctx.fillRect(-5, -11, 10, 11); ctx.fillStyle = c_main; ctx.fillRect(-3, -9, 6, 6); 
                ctx.fillStyle = c_metal; ctx.fillRect(-5, -18, 10, 8); ctx.fillStyle = c_dark; ctx.fillRect(-1, -15, 6, 2); ctx.fillStyle = c_main; ctx.fillRect(-2, -20, 4, 2); 
                ctx.fillStyle = c_dark; ctx.beginPath(); ctx.arc(-3, -4, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = c_main; ctx.beginPath(); ctx.arc(-3, -4, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = c_metal; ctx.fillRect(3, -9, 3, 4);
                ctx.save(); ctx.translate(5, -7); let rot = -0.5; let tx = 0; if (isAttacking) { if (attackProgress < 0.3) rot = -1.0; else if (attackProgress < 0.6) { rot = 1.5; tx = 5; } else rot = -0.5; }
                ctx.rotate(rot); ctx.translate(tx, 0); ctx.fillStyle = c_wood; ctx.fillRect(0, -2, 2, 6); ctx.fillStyle = isElite ? '#fff' : c_metal; ctx.fillRect(0, -12 - (isElite?4:0), isElite?3:2, 10+(isElite?4:0)); ctx.fillStyle = c_dark; ctx.fillRect(-1, -2, 4, 1); ctx.restore();
            } else if (this.type.name === 'SPEAR') {
                ctx.fillStyle = c_leather; ctx.fillRect(-4, -10, 8, 10); ctx.fillStyle = c_main; ctx.fillRect(-4, -10, 8, 5); 
                ctx.fillStyle = c_skin; ctx.fillRect(-3, -16, 7, 7); ctx.fillStyle = c_metal; 
                if (isElite) { ctx.fillStyle = '#f00'; ctx.beginPath(); ctx.moveTo(-6,-18); ctx.lineTo(6,-18); ctx.lineTo(0,-26); ctx.fill(); ctx.fillStyle = c_metal; }
                ctx.beginPath(); ctx.moveTo(-4, -16); ctx.lineTo(4, -16); ctx.lineTo(0, -22); ctx.fill(); ctx.fillStyle = c_leather; ctx.fillRect(-2, -7, 8, 3); 
                ctx.save(); let thrust = 0; if (isAttacking) { thrust = Math.sin(attackProgress * Math.PI) * 12; }
                ctx.translate(thrust, 0); ctx.fillStyle = c_wood; ctx.fillRect(-6, -6, 30, 2); ctx.fillStyle = isElite ? '#ffd700' : c_metal; 
                if (isElite) { ctx.fillRect(24, -9, 2, 8); ctx.fillRect(26, -9, 8, 2); ctx.fillRect(26, -3, 8, 2); } 
                ctx.beginPath(); ctx.moveTo(24, -7); ctx.lineTo(32, -5); ctx.lineTo(24, -3); ctx.fill(); ctx.restore();
            } else if (this.type.name === 'AXE') {
                ctx.fillStyle = c_skin; ctx.fillRect(-5, -11, 11, 11); if (isElite) { ctx.fillStyle = '#f00'; ctx.fillRect(-3, -10, 2, 8); ctx.fillRect(1, -10, 2, 8); } 
                ctx.fillStyle = c_main; ctx.fillRect(-5, -4, 11, 4); ctx.fillStyle = c_skin; ctx.fillRect(-4, -18, 9, 8); ctx.fillStyle = c_metal; ctx.fillRect(-5, -19, 11, 4); 
                ctx.fillStyle = "#eee"; if (isElite) { ctx.fillRect(-8, -24, 3, 8); ctx.fillRect(5, -24, 3, 8); } else { ctx.fillRect(-6, -21, 2, 4); ctx.fillRect(5, -21, 2, 4); }
                ctx.fillStyle = c_skin; ctx.fillRect(2, -9, 4, 5); ctx.save(); ctx.translate(4, -7); let rot = -0.2;
                if (isAttacking) { if (attackProgress < 0.4) rot = -1.5; else if (attackProgress < 0.7) rot = 1.5; else rot = -0.2; }
                ctx.rotate(rot); ctx.fillStyle = c_wood; ctx.fillRect(-1, -12, 2, 14); ctx.fillStyle = c_metal;
                ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(-6, -14); ctx.lineTo(-6, -6); ctx.fill(); ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(6, -14); ctx.lineTo(6, -6); ctx.fill(); ctx.restore();
            }
            if (this.level > 1) { ctx.fillStyle = "#ffd700"; ctx.font = "6px 'Press Start 2P'"; ctx.scale(this.isPlayer1?1:-1, 1); ctx.fillText("Lv."+this.level, -10, -24); }
            if (this.hp < this.maxHp) { if (this.level <= 1) ctx.scale(this.isPlayer1?1:-1, 1); ctx.fillStyle = "#f00"; ctx.fillRect(-8, -22, 16, 2); ctx.fillStyle = "#0f0"; ctx.fillRect(-8, -22, 16 * (this.hp/this.maxHp), 2); }
            ctx.restore();
        }
    }

    function spawnParticles(x, y, color, count) { for(let i=0; i<count; i++) { particles.push({ x: x, y: y, vx: (Math.random()-0.5)*100, vy: (Math.random()-0.5)*100, life: 0.5, color: color, size: Math.random()*4+2 }); } }
    function spawnEnvParticles(type) { const x = Math.random() * w; const y = (type === 'EMBER') ? h : -10; envParticles.push({ x: x, y: y, vx: (Math.random()-0.5)*20, vy: (type==='EMBER')?-(Math.random()*30+10):(Math.random()*50+20), life: Math.random()*3+2, type: type, size: Math.random()*3+1 }); }
    function createFloatText(x, y, text, color, size=12) { floatTexts.push({x,y,text,color,size,life:1.0,vy:-30}); }
    
    // Draft System
    function startDraft(pNum) {
        upgradeCurrentPlayer = pNum;
        const container = document.getElementById('upgrade-container'); container.innerHTML = '';
        const choices = []; while(choices.length<3) { const p = PERKS[Math.floor(Math.random()*PERKS.length)]; if(!choices.includes(p)) choices.push(p); }
        choices.forEach(p => {
            const el = document.createElement('div'); el.className = 'card-choice mode-card';
            el.innerHTML = `<div class="card-info"><div class="card-title">${p.names[currentLang]||p.names.en}</div><div class="card-icon">${p.icon}</div><div class="card-desc">${p.descs[currentLang]||p.descs.en}</div></div>`;
            el.onclick = () => {
                const pl = pNum===1?p1:p2; p.apply(pl); pl.battleStats.perks++;
                if(p.unitType==='ALL'){ pl.upgradeCounts.SWORD++; pl.upgradeCounts.SPEAR++; pl.upgradeCounts.AXE++; } else if(p.unitType) pl.upgradeCounts[p.unitType]++;
                SoundManager.playLevelUp();
                if(gameMode==='MULTI' && pNum===1) startDraft(2);
                else {
                    document.getElementById('upgrade-menu').style.display='none';
                    if(gameMode==='CAMPAIGN'){ const ep = PERKS[Math.floor(Math.random()*PERKS.length)]; ep.apply(p2); }
                    upgradeTimer = UPGRADE_INTERVAL; currentState = GAME_STATE.PLAYING;
                }
            };
            container.appendChild(el);
        });
        document.getElementById('upgrade-menu').style.display = 'flex';
    }

    // --- DRAWING FUNCTIONS ---
    function drawMenuRunner(ctx, runner) {
        ctx.save(); ctx.translate(runner.x, runner.y); const s = renderScale * 0.8; ctx.scale(s, s); const anim = Math.floor(runner.animFrame) % 4; const leg = anim % 2 === 0 ? 0 : (anim === 1 ? -3 : 3); const bob = anim % 2 === 0 ? 0 : -2; ctx.fillStyle = "#555"; ctx.fillRect(-2 + leg, 0, 3, 6); ctx.fillRect(2 - leg, 0, 3, 6); ctx.translate(0, bob); ctx.fillStyle = runner.unitType.color; ctx.fillRect(-4, -8, 8, 8); ctx.fillStyle = "#ffccaa"; ctx.fillRect(-3, -14, 6, 6); ctx.fillStyle = "#fff"; if(runner.unitType.name === 'SWORD') ctx.fillRect(4, -10, 6, 2); else if(runner.unitType.name === 'SPEAR') ctx.fillRect(4, -12, 10, 1); else ctx.fillRect(4, -12, 4, 4); ctx.restore();
    }
    function drawMenuScene(ctx) {
        const grad = ctx.createLinearGradient(0, 0, 0, h); grad.addColorStop(0, "#ff4e00"); grad.addColorStop(0.5, "#ff8c00"); grad.addColorStop(1, "#ffcc00"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); const scroll1 = (menuScroll * 0.2) % w; ctx.fillStyle = "#331111"; ctx.beginPath(); for(let i=-1; i<=1; i++) { ctx.moveTo(i*w - scroll1, h); ctx.lineTo(i*w - scroll1, h*0.5); ctx.lineTo(i*w + w*0.3 - scroll1, h*0.3); ctx.lineTo(i*w + w*0.6 - scroll1, h*0.45); ctx.lineTo(i*w + w*0.8 - scroll1, h*0.35); ctx.lineTo(i*w + w - scroll1, h*0.5); ctx.lineTo(i*w + w - scroll1, h); } ctx.fill(); const scroll2 = (menuScroll * 0.5) % w; ctx.fillStyle = "#552211"; for(let i=-1; i<=1; i++) { const baseX = i*w - scroll2; ctx.fillRect(baseX + w*0.1, h*0.55, w*0.05, h*0.05); ctx.fillRect(baseX + w*0.3, h*0.5, w*0.02, h*0.1); ctx.fillStyle = "#ff0000"; ctx.fillRect(baseX + w*0.32, h*0.5, w*0.03, w*0.02); ctx.fillStyle = "#552211"; ctx.fillRect(baseX + w*0.7, h*0.52, w*0.08, h*0.08); } const groundY = h * 0.6; const scroll3 = (menuScroll * 1.5) % 40; ctx.fillStyle = "#8b4513"; ctx.fillRect(0, groundY, w, h-groundY); ctx.fillStyle = "#a0522d"; for(let x = -scroll3; x < w; x += 40) { ctx.fillRect(x, groundY, 20, h-groundY); } menuEntities.sort((a,b) => a.y - b.y); menuEntities.forEach(e => { if (e.type === 'RUNNER') drawMenuRunner(ctx, e); else if (e.type === 'DUST') { ctx.fillStyle = `rgba(200, 180, 150, ${e.life})`; ctx.fillRect(e.x, e.y, e.size * renderScale, e.size * renderScale); } }); ctx.fillStyle = "rgba(255, 255, 200, 0.05)"; for(let i=0; i<5; i++) { const y = Math.random() * h; ctx.fillRect(0, y, w, Math.random() * 5); }
    }
    function drawBattleBackground(ctx) {
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        if (currentMapKey === 'GRASS') { grad.addColorStop(0, "#4a90e2"); grad.addColorStop(1, "#87ceeb"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "#2d6a4f"; ctx.beginPath(); ctx.ellipse(w*0.2, h*0.6, w*0.4, h*0.2, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#40916c"; ctx.beginPath(); ctx.ellipse(w*0.8, h*0.65, w*0.5, h*0.25, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "rgba(255,255,255,0.4)"; const t = Date.now() * 0.0005; ctx.beginPath(); ctx.arc((t*50)%w, h*0.2, 40*renderScale, 0, Math.PI*2); ctx.fill(); } 
        else if (currentMapKey === 'LAVA') { grad.addColorStop(0, "#300"); grad.addColorStop(1, "#600"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "#f50"; const flow = Math.sin(Date.now()*0.001) * 20; ctx.beginPath(); ctx.moveTo(0, h*0.6); ctx.bezierCurveTo(w*0.3, h*0.5+flow, w*0.7, h*0.7-flow, w, h*0.6); ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.fill(); ctx.fillStyle = "#200"; ctx.beginPath(); ctx.moveTo(w*0.2, h*0.7); ctx.lineTo(w*0.4, h*0.4); ctx.lineTo(w*0.6, h*0.7); ctx.fill(); }
        else if (currentMapKey === 'SNOW') { grad.addColorStop(0, "#a0b0cc"); grad.addColorStop(1, "#d0e0f0"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "#8a9bb0"; ctx.beginPath(); ctx.moveTo(0, h*0.7); ctx.lineTo(w*0.3, h*0.3); ctx.lineTo(w*0.6, h*0.7); ctx.fill(); ctx.fillStyle = "#9aabbd"; ctx.beginPath(); ctx.moveTo(w*0.4, h*0.7); ctx.lineTo(w*0.7, h*0.2); ctx.lineTo(w, h*0.7); ctx.fill(); }
    }
    function drawFortress(isPlayer1) { ctx.save(); ctx.translate(0, 0); ctx.scale(renderScale, renderScale); ctx.resetTransform(); ctx.scale(scaleRatio, scaleRatio); const s = renderScale; const baseX = isPlayer1 ? 40 : w - 40; const direction = isPlayer1 ? 1 : -1; const primary = isPlayer1 ? "#6688cc" : "#cc6666"; const secondary = isPlayer1 ? "#4466aa" : "#aa4444"; const stone = "#6a6a6a"; const darkStone = "#4a4a4a"; const topY = laneY[0] - 20; const botY = laneY[2] + 20; ctx.fillStyle = darkStone; ctx.fillRect(baseX - (10 * direction * s), topY, 20 * direction * s, botY - topY); ctx.fillStyle = stone; ctx.fillRect(baseX - (5 * direction * s), topY, 10 * direction * s, botY - topY); for (let i=0; i<3; i++) { const ly = laneY[i]; const isMiddle = (i === 1); ctx.save(); ctx.translate(baseX, ly); ctx.scale(direction * s, s); if (isMiddle) { ctx.fillStyle = stone; ctx.fillRect(-30, -50, 60, 50); ctx.fillStyle = darkStone; ctx.fillRect(-25, -50, 10, 50); ctx.fillRect(15, -50, 10, 50); ctx.fillStyle = "#221100"; ctx.fillRect(-15, -35, 30, 35); ctx.fillStyle = "#111"; ctx.fillRect(-15, -35, 30, 2); ctx.fillRect(-15, -25, 30, 2); ctx.fillRect(-15, -15, 30, 2); ctx.fillStyle = stone; ctx.fillRect(-35, -60, 70, 10); ctx.fillStyle = darkStone; [-35, -15, 5, 25].forEach(mx => ctx.fillRect(mx, -65, 10, 5)); ctx.fillStyle = "#888"; ctx.fillRect(-5, -85, 2, 25); ctx.fillStyle = primary; ctx.beginPath(); ctx.moveTo(-3, -85); ctx.lineTo(20, -75); ctx.lineTo(-3, -65); ctx.fill(); } else { ctx.fillStyle = stone; ctx.fillRect(-20, -40, 40, 40); ctx.fillStyle = "#222"; ctx.fillRect(-5, -25, 10, 15); ctx.fillStyle = darkStone; ctx.fillRect(-25, -45, 50, 10); ctx.fillStyle = secondary; ctx.beginPath(); ctx.moveTo(-25, -45); ctx.lineTo(0, -65); ctx.lineTo(25, -45); ctx.fill(); } ctx.restore(); } const hp = isPlayer1 ? p1.baseHealth : p2.baseHealth; const maxHp = 1000; const hpPct = Math.max(0, hp / maxHp); const barY = laneY[1] - (90 * s); const barH = 8 * s; const barW = 80 * s; ctx.fillStyle = "#000"; ctx.fillRect(baseX - barW/2, barY, barW, barH); ctx.fillStyle = isPlayer1 ? "#4f4" : "#f44"; ctx.fillRect(baseX - barW/2 + (2*s), barY + (2*s), (barW - 4*s) * hpPct, barH - (4*s)); ctx.restore(); }

    function draw() {
        if (currentState === GAME_STATE.MENU || currentState === GAME_STATE.CAMPAIGN_MENU || currentState === GAME_STATE.SKILL_TREE || currentState === GAME_STATE.MAP_SELECT || currentState === GAME_STATE.SLOT_LOBBY) { drawMenuScene(ctx); return; }
        if(!w||!h) { resize(); return; }
        drawBattleBackground(ctx);
        const map = MAPS[currentMapKey];
        mapObjects.forEach(d => { if (d.z > 0) return; const colors = map.decorColor; const s = renderScale; if (d.type === 'GRASS' || d.type === 'SNOW_PILE' || d.type === 'CRACK') { ctx.fillStyle = colors.grass; if (d.type === 'CRACK') { ctx.fillRect(d.x, d.y, 8*s, 2*s); ctx.fillRect(d.x+3*s, d.y+2*s, 2*s, 3*s); } else { ctx.fillRect(d.x, d.y, 4*s, 3*s); ctx.fillRect(d.x+2*s, d.y-2*s, 3*s, 3*s); } } else if (d.type === 'ROCK' || d.type === 'ICE_ROCK') { ctx.fillStyle = colors.rock; ctx.fillRect(d.x, d.y, 8*s, 5*s); if(d.type === 'ICE_ROCK') { ctx.fillStyle = "#fff"; ctx.fillRect(d.x+1*s, d.y+1*s, 2*s, 2*s); } } else if (d.type === 'FLOWER') { ctx.fillStyle = "#2a2"; ctx.fillRect(d.x, d.y, 2*s, 4*s); ctx.fillStyle = ["#f0f","#ff0","#0ff"][Math.floor(d.var*3)]; ctx.fillRect(d.x-1*s, d.y-2*s, 4*s, 2*s); } else if (d.type === 'BONE') { ctx.fillStyle = "#ddd"; ctx.fillRect(d.x, d.y, 6*s, 2*s); ctx.fillRect(d.x, d.y-1*s, 1*s, 4*s); ctx.fillRect(d.x+5*s, d.y-1*s, 1*s, 4*s); } });
        ctx.save();
        for(let i=0; i<3; i++) { const ly = laneY[i]; const roadH = 70 * renderScale; const roadY = ly - (35 * renderScale); ctx.fillStyle = map.road; ctx.fillRect(0, roadY, w, roadH); ctx.fillStyle = map.roadDetail; ctx.fillRect(0, roadY, w, 3*renderScale); ctx.fillRect(0, roadY + roadH - 3*renderScale, w, 3*renderScale); }
        roadDetails.forEach(d => { ctx.fillStyle = d.color; ctx.fillRect(d.x, d.y, 3*renderScale, 3*renderScale); });
        drawFortress(true); drawFortress(false);
        units.sort((a,b)=>a.y-b.y); units.forEach(u => u.draw(ctx));
        mapObjects.forEach(d => { if (d.z === 0) return; const tx = d.x; const ty = d.y; const colors = map.decorColor; const s = renderScale; if (d.type === 'TREE' || d.type === 'SNOW_TREE') { ctx.fillStyle = "#3e2723"; ctx.fillRect(tx-3*s, ty-10*s, 6*s, 10*s); ctx.fillStyle = colors.tree; ctx.fillRect(tx-12*s, ty-10*s, 24*s, 6*s); ctx.fillRect(tx-10*s, ty-16*s, 20*s, 6*s); ctx.fillRect(tx-6*s, ty-22*s, 12*s, 6*s); ctx.fillRect(tx-2*s, ty-26*s, 4*s, 4*s); if(d.type === 'SNOW_TREE') { ctx.fillStyle = "#fff"; ctx.fillRect(tx-12*s, ty-10*s, 4*s, 2*s); ctx.fillRect(tx, ty-16*s, 6*s, 2*s); ctx.fillRect(tx-2*s, ty-26*s, 4*s, 2*s); } } else if (d.type === 'DEAD_TREE') { ctx.fillStyle = colors.tree; ctx.fillRect(tx-2*s, ty-15*s, 4*s, 15*s); ctx.fillRect(tx-6*s, ty-10*s, 4*s, 2*s); ctx.fillRect(tx+2*s, ty-18*s, 4*s, 2*s); } });
        particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size * renderScale, p.size * renderScale); });
        envParticles.forEach(p => { if (p.type === 'SNOW') ctx.fillStyle = "#fff"; else if (p.type === 'EMBER') ctx.fillStyle = Math.random() > 0.5 ? "#f00" : "#ff0"; ctx.fillRect(p.x, p.y, p.size * renderScale, p.size * renderScale); });
        ctx.font = `${12 * renderScale}px 'Press Start 2P'`; floatTexts.forEach(f => { ctx.fillStyle = f.color; ctx.fillText(f.text, f.x - 10*renderScale, f.y); }); ctx.restore();
        if (map.vignette) { const grad = ctx.createRadialGradient(w/2, h/2, h/3, w/2, h/2, h); grad.addColorStop(0, "rgba(0,0,0,0)"); grad.addColorStop(1, map.vignette); ctx.fillStyle = grad; ctx.fillRect(0,0,w,h); }
        
        ctx.fillStyle = "#444"; const exitW = 60 * renderScale; const exitH = 30 * renderScale; ctx.fillRect(10, 10, exitW, exitH); ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.strokeRect(10, 10, exitW, exitH); ctx.fillStyle = "#fff"; ctx.font = `${10 * renderScale}px 'Press Start 2P'`; ctx.textAlign = "center"; ctx.fillText(t('EXIT'), 10 + exitW/2, 10 + exitH/1.5);
        const barW = 150 * renderScale; const barH = 16 * renderScale; const safeY = h - (18 * h / 100) - barH - 10;
        ctx.fillStyle = "#000"; ctx.fillRect(40 * renderScale, safeY, barW, barH); ctx.fillStyle = "#44f"; ctx.fillRect(40 * renderScale + 2, safeY + 2, (barW - 4) * (p1.energy / 200), barH - 4);
        if(gameMode === 'MULTI') { const x2 = w - barW - 40 * renderScale; ctx.fillStyle = "#000"; ctx.fillRect(x2, safeY, barW, barH); ctx.fillStyle = "#f44"; ctx.fillRect(x2 + 2, safeY + 2, (barW - 4) * (p2.energy / 200), barH - 4); }
    }
    
    // Inputs
    canvas.addEventListener('pointerdown', (e) => {
        if(currentState!==GAME_STATE.PLAYING) return;

        //Â¶ÇÊûúÈªûÊìäÁöÑÊòØ UI Â±§ÁöÑÊåâÈàïÔºå‰∏çË¶ÅËß∏Áôº Canvas ÈÇèËºØ
        if (e.target !== canvas) return;

        
        const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
        if(x<80 && y<50) { 
            if (gameMode === 'MULTI') showMainMenu();
            else showSlotLobby(); // Return to lobby in campaign
            return; 
        }
        for(let i=0; i<3; i++) {
            if(Math.abs(y-laneY[i])<40) {
                if(gameMode==='MULTI' && x>w/2) { if(p2.energy>=20) { p2.energy-=20; units.push(new Unit(i,p2.selectedUnit,false)); SoundManager.playSpawn(); } }
                else { if(p1.energy>=20) { p1.energy-=20; p1.battleStats.spawned++; p1.unitCounts[p1.selectedUnit.name]++; units.push(new Unit(i,p1.selectedUnit,true)); SoundManager.playSpawn(); } }
            }
        }
    });

    function gameOver(p1Wins) {
        SoundManager.stopBGM(); currentState = GAME_STATE.GAMEOVER;
        const scr = document.getElementById('game-over-screen'); 
        const txt = document.getElementById('winner-text'); 
        const sub = document.getElementById('game-over-subtext');
        
        if (gameMode === 'CAMPAIGN' && p1Wins) {
            if(currentSlotData) {
                currentSlotData.meta.stars++; // ÊØèÈóúÈÇÑÊòØÁµ¶ÊòüÊòü
                
                // --- ÁÑ°ÈôêËº™Ëø¥ÈÇèËºØ ---
                if (currentLevel < MAX_LEVELS) {
                    // ‰∏ÄËà¨ÈÅéÈóú
                    txt.innerText = "STAGE CLEAR"; 
                    txt.style.color = "#0f0"; 
                    sub.dataset.action = 'next';
                    currentLevel++;
                } else {
                    // Á¨¨ 10 ÈóúÈÄöÈóú -> ÈÄ≤ÂÖ•‰∏ã‰∏ÄÂÄã Loop
                    txt.innerText = `LOOP ${currentLoop} COMPLETE!`; 
                    txt.style.color = "#ffd700"; // ÈáëËâ≤
                    sub.dataset.action = 'next'; // ÁπºÁ∫åÂãï‰Ωú‰ªçÁÑ∂ÊòØ next
                    
                    // ÈáçÁΩÆÈóúÂç°ÔºåÊèêÂçá Loop
                    currentLevel = 1;
                    currentLoop++;
                }
                
                // ‰øùÂ≠òÈÄ≤Â∫¶ (ÂåÖÂê´Êñ∞ÁöÑ loop Âíå level)
                currentSlotData.run = { 
                    level: currentLevel, 
                    loop: currentLoop, // ‰øùÂ≠ò loop
                    p1Stats: p1.stats, 
                    p1Upgrades: p1.upgradeCounts, 
                    p1BattleStats: p1.battleStats 
                };
                saveCurrentSlot();
            }
        } else {
            // Â§±ÊïóÈÇèËºØ‰∏çËÆä
            txt.innerText = p1Wins ? t('VICTORY') : t('DEFEAT'); 
            txt.style.color = p1Wins ? "#0f0" : "#f00"; 
            sub.dataset.action = 'menu';
        }
        
        // ... (‰∏ãÊñπÁµ±Ë®àÊï∏ÊìöÈ°ØÁ§∫‰ª£Á¢º‰∏çËÆä) ...
        const getFav = (p) => { let m=0,n="-"; for(let k in p.unitCounts){if(p.unitCounts[k]>m){m=p.unitCounts[k];n=t(k);}} return n; };
        document.getElementById('stats-container').innerHTML = `
            <div class="stats-row"><div style="color:#44f">${p1.battleStats.spawned}</div><div>${t('STAT_SPAWNED')}</div><div style="color:#f44">${p2.battleStats.spawned}</div></div>
            <div class="stats-row"><div style="color:#44f">${p1.battleStats.damage}</div><div>${t('STAT_DAMAGE')}</div><div style="color:#f44">${p2.battleStats.damage}</div></div>
            <div class="stats-row"><div style="color:#44f">${getFav(p1)}</div><div>${t('FAV_UNIT')}</div><div style="color:#f44">${getFav(p2)}</div></div>
        `;
        updateUIText(); scr.style.display = 'flex';
    }
    
        window.handleGameOverClick = function() { 
                const sub = document.getElementById('game-over-subtext'); 
        
            // --- ÈªûÊìä‰∫Ü„ÄåÂõûÂà∞ÈÅ∏ÂñÆ„Äç ---
                if (sub.dataset.action === 'menu') { 
                    if (gameMode === 'MULTI') showMainMenu();
                    else showSlotLobby();
                } 
                // --- ÈªûÊìä‰∫Ü„Äå‰∏ã‰∏ÄÈóú„Äç (ÂãùÂà©) ---
                else if (sub.dataset.action === 'next') { 
                    // üõë ‰øÆÊîπÈÄôË£°ÔºöÂéüÊú¨ÊòØÁõ¥Êé• startGame(true)
                    // ‚úÖ ÊîπÊàêÔºöÂÖàÈ°ØÁ§∫È™∞Â≠êÈÅäÊà≤
                    showDiceGame();
                } 
            };

    // --- REPLACED: Custom Modal Logic instead of confirm() ---
    function showModal(msg, onYes) {
        const m = document.getElementById('custom-modal');
        const t = document.getElementById('modal-msg');
        const y = document.getElementById('modal-yes');
        const n = document.getElementById('modal-no');
        t.innerText = msg; m.style.display = 'flex';
        y.onclick = () => { m.style.display = 'none'; onYes(); };
        n.onclick = () => { m.style.display = 'none'; };
    }

    window.deleteSlot = function(e, id) { 
        e.stopPropagation(); 
        showModal(t('CONFIRM_DELETE'), () => {
            localStorage.removeItem(SAVE_PREFIX + id);
            SoundManager.playHit();
            renderSaveSlots();
        });
    };
    
    // Updated: Open Lobby instead of start game immediately
    window.activateSlot = function(id) {
        SoundManager.playButton(); currentSlotId = id; const data = getSlotData(id);
        if (data) {
            currentSlotData = data;
        } else {
            currentSlotData = getEmptySlotData(); saveCurrentSlot();
        }
        showSlotLobby();
    };
    
    window.renderSaveSlots = function() {
        const container = document.getElementById('save-slot-container'); container.innerHTML = '';
        for(let i=1; i<=3; i++) {
            const data = getSlotData(i); const slotEl = document.createElement('div');
            
            if (data) {
                const loopTag = data.run && data.run.loop > 0 ? ` (Loop ${data.run.loop})` : '';
                 let info = `‚≠ê ${data.meta.stars}`;
        
                if(data.run) info += ` | ${t('STAGE')} ${data.run.level}${loopTag}`; 
                else info += ` | ${t('NEW_GAME')}`;

                slotEl.className = 'save-slot';
                // Activate Click
                slotEl.onclick = () => activateSlot(i);
                
                slotEl.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <div class="slot-icon">üíæ</div>
                        <div class="save-slot-info">
                            <div class="slot-title">${t('SLOT')} ${i}</div>
                            <div class="slot-details" style="color:#ffd700">${info}</div>
                        </div>
                    </div>
                    <div class="slot-delete-btn">üóëÔ∏è</div>
                `;

                // Delete Click (Bind via JS for safety)
                const delBtn = slotEl.querySelector('.slot-delete-btn');
                delBtn.onclick = (e) => {
                    // Calls our new custom delete logic
                    window.deleteSlot(e, i);
                };

            } else {
                slotEl.className = 'save-slot empty'; slotEl.onclick = () => activateSlot(i);
                slotEl.innerHTML = `<div style="display:flex; align-items:center;"><div class="slot-icon" style="opacity:0.5">üìÇ</div><div class="save-slot-info"><div class="slot-title" style="color:#888;">${t('SLOT')} ${i}</div><div class="slot-details">${t('EMPTY_SLOT')}</div></div></div>`;
            }
            container.appendChild(slotEl);
        }
    };

    function loop(t) { let dt=(t-lastTime)/1000; lastTime=t; if(dt>0.1)dt=0.1; update(dt); draw(); animationId=requestAnimationFrame(loop); }
    window.pixelGameCleanup = function() { SoundManager.stopBGM(); cancelAnimationFrame(animationId); window.removeEventListener('resize', resize); };
    
   	
	// --- Êñ∞Â¢ûÔºöÂïüÂãïÂáΩÂºè (Áî± Splash Screen Ëß∏Áôº) ---
    window.startApp = function() {
        // 1. Ëß£Èéñ AudioContext (ÁÄèË¶ΩÂô®ÈúÄË¶Å‰ΩøÁî®ËÄÖ‰∫íÂãïÊâçËÉΩÊí≠ÊîæËÅ≤Èü≥)
        SoundManager.init();
        SoundManager.playBGM('MENU');
        SoundManager.playButton(); // Áµ¶ÂÄãÂõûÈ•ãÈü≥Êïà
        
        // 2. Èö±Ëóè Splash Screen
        document.getElementById('splash-screen').style.display = 'none';
        
        // 3. Á¢∫‰øùÈÄ≤ÂÖ•‰∏ªÈÅ∏ÂñÆÁãÄÊÖã
        showMainMenu();
    };
    
    // --- ÈÅäÊà≤ÂàùÂßãÂåñ (‰øÆÊîπÂæå) ---
    initMenuEntities(); 
    resize(); 
    // SoundManager.playBGM('MENU'); // ‚ùå ÁßªÈô§ÈÄôË°åÔºå‰∏çË¶ÅËá™ÂãïÊí≠Êîæ
    requestAnimationFrame(loop);     // Âè™ÂïüÂãïÁï´Èù¢Âæ™Áí∞ÔºåÁ≠âÂæÖÁé©ÂÆ∂ÈªûÊìä

})(); // ÈñâÂåÖÁµêÊùü

</script>
</body>
</html>